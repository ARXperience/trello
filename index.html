<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Task Ultimate v30.1</title>
    <style>
        /* --- VARIABLES CSS (THEMING) --- */
        :root {
            --primary: #0079bf; --primary-dark: #055a8c;
            --bg: #ffffff; --sidebar: #f4f5f7; --surface: #ffffff;
            --text: #172b4d; --text-sub: #5e6c84; --border: #dfe1e6;
            --success: #61bd4f; --danger: #eb5a46; --warning: #ff9f1a; --info: #00c2e0;
            --shadow: 0 1px 2px rgba(0,0,0,0.15);
            --radius: 6px;
        }

        [data-theme="dark"] {
            --primary: #4a90e2; --primary-dark: #357abd;
            --bg: #1e1e1e; --sidebar: #252526; --surface: #2d2d30;
            --text: #e1e1e1; --text-sub: #a1a1a1; --border: #3e3e42;
            --shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); background: var(--bg); transition: background 0.3s; }
        
        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; }
        
        /* HEADER & SEARCH */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 20px; height: 55px; display: flex; align-items: center; justify-content: space-between; }
        .search-box { position: relative; width: 250px; }
        .search-box input { width: 100%; padding: 6px 10px 6px 30px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        .search-box span { position: absolute; left: 10px; top: 6px; color: var(--text-sub); }

        /* KANBAN */
        .kanban { display: flex; padding: 20px; gap: 15px; overflow-x: auto; height: 100%; align-items: flex-start; }
        .list { background: var(--sidebar); width: 280px; min-width: 280px; border-radius: var(--radius); padding: 10px; max-height: 90%; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .list h4 { margin: 0 0 10px 5px; color: var(--text); font-weight: 700; display:flex; justify-content:space-between; }
        .cards { flex: 1; overflow-y: auto; min-height: 20px; padding-right: 4px; }
        
        /* TARJETAS AVANZADAS */
        .card { background: var(--surface); padding: 0; margin-bottom: 10px; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); position: relative; transition: transform 0.15s, box-shadow 0.15s; overflow: hidden; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .card-cover { height: 80px; background-size: cover; background-position: center; display: none; }
        .card-content { padding: 10px; }
        
        /* Etiquetas */
        .card-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 5px; }
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 600; }
        .tag.bug { background: var(--danger); }
        .tag.design { background: #9b59b6; }
        .tag.urgent { background: var(--warning); }
        .tag.feature { background: var(--info); }
        
        /* Meta Datos */
        .card-meta { display: flex; gap: 8px; margin-top: 8px; font-size: 0.75rem; color: var(--text-sub); align-items: center; }
        .meta-badge { display: flex; align-items: center; gap: 3px; background: var(--bg); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border); }
        .meta-badge.overdue { background: #ffe3e3; color: var(--danger); border-color: var(--danger); }
        .meta-badge.today { background: #fff8e1; color: var(--warning); border-color: var(--warning); }
        
        /* Barra Progreso */
        .progress-bar { height: 4px; background: #eee; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        
        /* Avatares */
        .avatars { display: flex; margin-top: 8px; justify-content: flex-end; }
        .avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; border: 2px solid var(--surface); margin-left: -5px; }

        /* --- MEN√ö CONTEXTUAL --- */
        #context-menu { position: absolute; background: var(--surface); border: 1px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 4px; width: 150px; display: none; z-index: 5000; overflow: hidden; }
        .ctx-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; color: var(--text); }
        .ctx-item:hover { background: var(--sidebar); }
        .ctx-danger { color: var(--danger); }

        /* --- MODALES --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .box { background: var(--surface); padding: 25px; border-radius: 8px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .modal-lg { width: 700px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* Modal Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .tab { padding: 10px 15px; cursor: pointer; color: var(--text-sub); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        
        /* Comentarios */
        .comment-list { max-height: 200px; overflow-y: auto; background: var(--sidebar); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .comment-item { font-size: 0.85rem; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #ddd; }
        .comment-header { font-weight: bold; font-size: 0.75rem; color: var(--primary); display: flex; justify-content: space-between; }

        /* Actividad / Log */
        .activity-panel { position: fixed; right: -300px; top: 55px; bottom: 0; width: 300px; background: var(--surface); border-left: 1px solid var(--border); transition: 0.3s; padding: 20px; overflow-y: auto; z-index: 1000; }
        .activity-panel.open { right: 0; }
        .log-item { font-size: 0.8rem; margin-bottom: 10px; color: var(--text-sub); border-left: 2px solid var(--border); padding-left: 8px; }

        /* UI Elements */
        input, select, textarea { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; font-family: inherit; }
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--sidebar); }
        
        /* Toast Undo */
        #toast-undo { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 4px; display: none; align-items: center; gap: 15px; z-index: 6000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="context-menu">
        <div class="ctx-item" onclick="window.duplicateTaskCtx()">üìÑ Duplicar</div>
        <div class="ctx-item" onclick="window.moveTaskCtx('done')">‚úÖ Mover a Hecho</div>
        <div class="ctx-item ctx-danger" onclick="window.deleteTaskCtx()">üóëÔ∏è Eliminar</div>
    </div>

    <div id="toast-undo">
        <span>Acci√≥n realizada</span>
        <button class="btn-primary" style="padding:4px 8px; font-size:0.8rem;" onclick="window.undoAction()">DESHACER</button>
    </div>

    <div id="activity-panel" class="activity-panel">
        <h3>üìú Historial</h3>
        <div id="activity-list"></div>
    </div>

    <div id="auth-screen" class="overlay" style="background: var(--primary);">
        <div class="box">
            <h2 style="color:var(--primary); text-align:center;">Pro-Task Ultimate</h2>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="window.login()">Entrar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px;" onclick="window.register()">Registrarse</button>
            <p id="auth-msg" style="color:var(--danger); font-size:0.8rem; text-align:center;"></p>
        </div>
    </div>

    <div id="app-screen" class="app-container" style="display: none;">
        
        <div class="sidebar">
            <div style="padding:15px; font-weight:bold; color:var(--primary); display:flex; align-items:center; gap:10px;">
                <span>‚ö° PRO-TASK</span>
                <button onclick="window.toggleTheme()" style="background:none; border:none; font-size:1.2rem;">üåì</button>
            </div>
            
            <div style="padding:0 10px; font-size:0.75rem; color:var(--text-sub); font-weight:bold;">MIS PROYECTOS</div>
            <div id="my-boards" style="flex:1; overflow-y:auto; padding:10px;"></div>
            
            <div style="padding:0 10px; font-size:0.75rem; color:var(--text-sub); font-weight:bold;">COMPARTIDOS</div>
            <div id="shared-boards" style="max-height:150px; overflow-y:auto; padding:10px;"></div>
            
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn-primary" style="width:100%;" onclick="window.createBoard()">+ Nuevo</button>
                <div onclick="window.openTrash()" style="margin-top:10px; cursor:pointer; color:var(--text-sub); font-size:0.9rem; display:flex; align-items:center; gap:5px;">
                    üóëÔ∏è Papelera
                </div>
            </div>
        </div>

        <div class="main">
            <header>
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" placeholder="Buscar tarjetas..." onkeyup="window.filterCards(this.value)">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-ghost" onclick="window.toggleActivity()">üìú Log</button>
                    <button class="btn-ghost" onclick="window.exportCSV()">üìä Exportar</button>
                    <button class="btn-ghost" onclick="window.openStats()">üìà Stats</button>
                    
                    <div style="position:relative; cursor:pointer; margin:0 10px;" onclick="window.openUnread()">
                        üîî <span id="bell-count" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; font-size:0.6rem; padding:2px 4px; border-radius:10px; display:none;">0</span>
                    </div>
                    
                    <span id="user-display" style="font-size:0.8rem; font-weight:bold;"></span>
                    <button class="btn-ghost" onclick="window.logout()">Salir</button>
                </div>
            </header>

            <div style="padding:10px 20px; display:flex; justify-content:space-between; align-items:center;">
                <h2 id="header-title" style="margin:0;">Selecciona un Tablero</h2>
                <div id="board-actions" style="display:none;">
                    <button class="btn-ghost" onclick="window.openShare()">üë§ Invitar</button>
                    <button class="btn-ghost" style="color:var(--danger);" onclick="window.softDeleteBoard()">üóëÔ∏è Borrar Tablero</button>
                </div>
            </div>

            <div id="kanban" class="kanban"></div>
        </div>
    </div>

    <div id="task-modal" class="overlay" style="display: none;">
        <div class="box modal-lg">
            <span onclick="window.closeModals()" style="align-self:flex-end; cursor:pointer; font-size:1.5rem;">&times;</span>
            
            <div id="m-cover-preview" style="height:100px; background:#eee; border-radius:4px; margin-bottom:10px; background-size:cover; background-position:center; display:none;"></div>

            <input type="text" id="m-title" style="font-size:1.5rem; font-weight:bold; border:none; padding:5px 0; background:transparent;" placeholder="T√≠tulo de la tarea" onblur="window.updateTask()">

            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('details')">Detalles</div>
                <div class="tab" onclick="window.switchTab('comments')">Comentarios</div>
                <div class="tab" onclick="window.switchTab('files')">Adjuntos</div>
            </div>

            <div id="tab-details">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Asignar a</label>
                        <select id="m-assignee" onchange="window.updateTask()"></select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Etiqueta</label>
                        <select id="m-tag" onchange="window.updateTask()">
                            <option value="">Ninguna</option>
                            <option value="bug">üêõ Bug</option>
                            <option value="feature">‚ú® Feature</option>
                            <option value="urgent">üî• Urgente</option>
                            <option value="design">üé® Dise√±o</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Vencimiento</label>
                        <input type="date" id="m-due" onchange="window.updateTask()">
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Tiempo (Cron√≥metro)</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <button id="btn-timer" class="btn-ghost" onclick="window.toggleTimer()">‚ñ∂Ô∏è</button>
                            <span id="m-timer-display" style="font-weight:bold;">00:00</span>
                        </div>
                    </div>
                </div>

                <label style="font-size:0.8rem; color:var(--text-sub);">Descripci√≥n</label>
                <textarea id="m-desc" rows="3" onblur="window.updateTask()"></textarea>

                <div style="margin-top:15px;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>Checklist</strong>
                        <span id="m-progress-text" style="font-size:0.8rem;">0%</span>
                    </div>
                    <div class="progress-bar"><div id="m-progress-bar" class="progress-fill"></div></div>
                    <div id="m-checklist" style="margin-top:10px;"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input id="m-new-check" placeholder="Nueva subtarea..." onkeypress="if(event.key==='Enter') window.addCheck()">
                        <button class="btn-ghost" onclick="window.addCheck()">+</button>
                    </div>
                </div>
            </div>

            <div id="tab-comments" style="display:none;">
                <div id="comment-list" class="comment-list"></div>
                <div style="display:flex; gap:5px;">
                    <input id="m-new-comment" placeholder="Escribe un comentario...">
                    <button class="btn-primary" onclick="window.addComment()">Enviar</button>
                </div>
            </div>

            <div id="tab-files" style="display:none;">
                <label>Link de Portada (Imagen)</label>
                <input id="m-cover-url" placeholder="https://..." onblur="window.updateTask()">
                <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                <div id="file-list"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input id="m-file-name" placeholder="Nombre (ej: Drive)">
                    <input id="m-file-url" placeholder="URL">
                    <button class="btn-ghost" onclick="window.addFile()">+</button>
                </div>
            </div>

            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px; text-align:right;">
                <button class="btn-danger" onclick="window.deleteTask()">Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="overlay" style="display:none;">
        <div class="box">
            <h3>Invitar Miembro</h3>
            <input id="share-email" placeholder="Email">
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="window.shareBoard()">Enviar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px;" onclick="window.closeModals()">Cancelar</button>
        </div>
    </div>

    <div id="stats-modal" class="overlay" style="display:none;">
        <div class="box">
            <h3>Estad√≠sticas</h3>
            <div id="stats-content"></div>
            <button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="window.closeModals()">Cerrar</button>
        </div>
    </div>

    <div id="trash-modal" class="overlay" style="display:none;">
        <div class="box modal-lg">
            <h3>Papelera</h3>
            <div id="trash-list"></div>
            <button class="btn-ghost" onclick="window.closeModals()">Cerrar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyAQnrIODc_2Qv_Snow02X-Sq8_PHwMoRVk", 
            authDomain: "trello-d2532.firebaseapp.com",
            projectId: "trello-d2532",
            storageBucket: "trello-d2532.firebasestorage.app",
            messagingSenderId: "630892154656",
            appId: "1:630892154656:web:1d0dfce355216a1d879145"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app, "pro-task-app");

        let currentUser = null;
        let currentBoardId = null;
        let boardData = null;
        let editTask = null;
        let editCol = null;
        let activeTimers = {};
        let undoStack = null; 
        let undoTimeout = null;

        // --- DEFINICI√ìN DE FUNCIONES INTERNAS ---

        // Helpers
        const _id = (x) => document.getElementById(x);
        const _val = (x) => document.getElementById(x).value;
        const closeModals = () => document.querySelectorAll('.overlay').forEach(e => { if(e.id!=='auth-screen') e.style.display='none'; });

        // Auth
        const login = () => signInWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => document.getElementById('auth-msg').innerText = e.message);
        const register = () => createUserWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => document.getElementById('auth-msg').innerText = e.message);
        const logout = () => { signOut(auth); location.reload(); };

        // Core
        const createBoard = async () => {
            const name = prompt("Nombre:");
            if(!name) return;
            const res = await addDoc(collection(db, 'boards'), {
                name, ownerId: currentUser.uid, members: [currentUser.email],
                deleted: false, createdAt: serverTimestamp(),
                columns: { todo: [], doing: [], done: [] },
                activityLog: []
            });
            openBoard(res.id);
        };

        const openBoard = (id) => {
            currentBoardId = id;
            onSnapshot(doc(db, 'boards', id), snap => {
                if(!snap.exists() || snap.data().deleted) return document.getElementById('kanban').innerHTML = '<p style="padding:20px; color:var(--text-sub)">Tablero no disponible o eliminado.</p>';
                boardData = snap.data();
                document.getElementById('header-title').innerText = boardData.name;
                document.getElementById('board-actions').style.display = (boardData.ownerId === currentUser.uid) ? 'block' : 'none';
                renderKanban();
                renderActivityLog();
            });
        };

        const addTask = (col) => {
            const t = prompt("Tarea:");
            if(!t) return;
            const newTask = { 
                id: Date.now().toString(), title: t, desc: '', 
                checklist: [], comments: [], files: [], 
                tag: '', due: '', assignedTo: '', cover: '', 
                timeLog: 0, createdBy: currentUser.email 
            };
            boardData.columns[col].push(newTask);
            logActivity(`cre√≥ tarea "${t}"`);
            save();
        };

        const handleDrop = (e, dest) => {
            e.preventDefault();
            const data = e.dataTransfer.getData('text');
            if(!data) return;
            const {id, src} = JSON.parse(data);
            if(src === dest) return;
            const taskIdx = boardData.columns[src].findIndex(t => t.id === id);
            if(taskIdx === -1) return;
            const [task] = boardData.columns[src].splice(taskIdx, 1);
            boardData.columns[dest].push(task);
            logActivity(`movi√≥ tarea "${task.title}" a ${dest}`);
            save();
        };

        const save = async () => {
            await updateDoc(doc(db, 'boards', currentBoardId), { 
                columns: boardData.columns,
                activityLog: boardData.activityLog || []
            });
        };

        const logActivity = (msg) => {
            if(!boardData.activityLog) boardData.activityLog = [];
            boardData.activityLog.unshift(`${new Date().toLocaleTimeString()} - ${currentUser.email} ${msg}`);
            if(boardData.activityLog.length > 50) boardData.activityLog.pop();
        };

        // Render Kanban
        const renderKanban = () => {
            const container = _id('kanban'); container.innerHTML = '';
            const cols = { todo: "Por Hacer", doing: "En Progreso", done: "Finalizado" };
            
            for (let k in cols) {
                const list = document.createElement('div'); list.className = 'list';
                
                const cardCont = document.createElement('div'); cardCont.className = 'cards';
                cardCont.id = k;
                cardCont.ondragover = e => e.preventDefault();
                cardCont.ondrop = e => handleDrop(e, k); // Uso interno correcto

                (boardData.columns[k] || []).forEach(task => cardCont.appendChild(createCard(task, k)));

                list.innerHTML = `<h4>${cols[k]} <span>${(boardData.columns[k]||[]).length}</span></h4>`;
                list.appendChild(cardCont);
                
                // Bot√≥n a√±adir
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-ghost';
                addBtn.style.width = '100%'; addBtn.style.textAlign = 'left';
                addBtn.innerText = '+ A√±adir';
                addBtn.onclick = () => addTask(k); // Uso interno correcto
                list.appendChild(addBtn);

                container.appendChild(list);
            }
        };

        const createCard = (task, col) => {
            const el = document.createElement('div');
            el.className = 'card';
            el.draggable = true;
            el.ondragstart = e => e.dataTransfer.setData('text', JSON.stringify({id: task.id, src: col}));
            el.oncontextmenu = e => showContext(e, task, col);
            el.onclick = () => openTaskModal(task, col); // Uso interno correcto

            let html = '';
            if(task.cover) html += `<div class="card-cover" style="display:block; background-image:url('${task.cover}')"></div>`;
            html += `<div class="card-content">`;
            if(task.tag) html += `<div class="card-tags"><span class="tag ${task.tag}">${task.tag.toUpperCase()}</span></div>`;
            html += `<strong>${task.title}</strong>`;
            
            html += `<div class="card-meta">`;
            if(task.due) {
                const today = new Date().toISOString().split('T')[0];
                const cls = task.due < today ? 'overdue' : (task.due === today ? 'today' : '');
                html += `<span class="meta-badge ${cls}">üìÖ ${task.due.slice(5)}</span>`;
            }
            if(task.checklist && task.checklist.length > 0) {
                const done = task.checklist.filter(c => c.done).length;
                html += `<span class="meta-badge">‚òë ${done}/${task.checklist.length}</span>`;
            }
            if(task.files && task.files.length) html += `<span class="meta-badge">üìé ${task.files.length}</span>`;
            html += `</div>`;

            if(task.assignedTo) {
                html += `<div class="avatars"><div class="avatar" title="${task.assignedTo}">${task.assignedTo.substring(0,2).toUpperCase()}</div></div>`;
            }

            if(task.checklist && task.checklist.length > 0) {
                const pct = Math.round((task.checklist.filter(c => c.done).length / task.checklist.length) * 100);
                html += `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
            }
            html += `</div>`;
            el.innerHTML = html;
            return el;
        };

        // Modales y Tareas
        const openTaskModal = (task, col) => {
            editTask = task; editCol = col;
            _id('task-modal').style.display = 'flex';
            
            _id('m-title').value = task.title;
            _id('m-desc').value = task.desc || '';
            _id('m-due').value = task.due || '';
            _id('m-tag').value = task.tag || '';
            _id('m-cover-url').value = task.cover || '';
            
            const sel = _id('m-assignee'); sel.innerHTML = '<option value="">Sin asignar</option>';
            (boardData.members || [currentUser.email]).forEach(m => {
                sel.innerHTML += `<option value="${m}" ${task.assignedTo===m?'selected':''}>${m}</option>`;
            });

            if(task.cover) { _id('m-cover-preview').style.display='block'; _id('m-cover-preview').style.backgroundImage=`url('${task.cover}')`; }
            else _id('m-cover-preview').style.display='none';

            updateTimerDisplay();
            renderChecklist(); renderComments(); renderFiles();
            switchTab('details');
        };

        const updateTask = () => {
            if(!editTask) return;
            editTask.title = _id('m-title').value;
            editTask.desc = _id('m-desc').value;
            editTask.due = _id('m-due').value;
            editTask.tag = _id('m-tag').value;
            editTask.assignedTo = _id('m-assignee').value;
            editTask.cover = _id('m-cover-url').value;
            save();
        };

        const switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['details','comments','files'].forEach(t => _id('tab-'+t).style.display = (t===tab?'block':'none'));
        };

        // Checklist, Comments, Files
        const addCheck = () => {
            const val = _id('m-new-check').value; if(!val) return;
            editTask.checklist.push({text: val, done: false}); _id('m-new-check').value=''; renderChecklist(); save();
        };
        const toggleCheck = (i) => { editTask.checklist[i].done = !editTask.checklist[i].done; renderChecklist(); save(); };
        const renderChecklist = () => {
            const list = _id('m-checklist'); list.innerHTML = '';
            let done = 0;
            (editTask.checklist||[]).forEach((c, i) => {
                if(c.done) done++;
                // Checkbox con onchange apuntando a window.toggleCheck
                const item = document.createElement('div');
                item.style.display='flex'; item.style.gap='10px'; item.style.marginBottom='5px';
                item.innerHTML = `<input type="checkbox" ${c.done?'checked':''}> <span>${c.text}</span>`;
                item.querySelector('input').onchange = () => toggleCheck(i);
                list.appendChild(item);
            });
            const pct = editTask.checklist.length ? Math.round((done/editTask.checklist.length)*100) : 0;
            _id('m-progress-bar').style.width = pct + '%'; _id('m-progress-text').innerText = pct + '%';
        };

        const addComment = () => {
            const txt = _id('m-new-comment').value; if(!txt) return;
            editTask.comments.push({user: currentUser.email, text: txt, date: new Date().toISOString()}); _id('m-new-comment').value=''; renderComments(); save();
        };
        const renderComments = () => {
            _id('comment-list').innerHTML = (editTask.comments||[]).map(c => `<div class="comment-item"><div class="comment-header"><span>${c.user}</span><span>${c.date.slice(0,10)}</span></div><div>${c.text}</div></div>`).join('');
        };

        const addFile = () => {
            editTask.files.push({name: _id('m-file-name').value||'Link', url: _id('m-file-url').value}); renderFiles(); save();
        };
        const renderFiles = () => {
            _id('file-list').innerHTML = (editTask.files||[]).map(f => `<a href="${f.url}" target="_blank" style="display:block; padding:5px; background:#eee; margin:5px 0; border-radius:4px; text-decoration:none; color:var(--primary);">üìé ${f.name}</a>`).join('');
        };

        const toggleTimer = () => {
            if(activeTimers[editTask.id]) {
                clearInterval(activeTimers[editTask.id]); delete activeTimers[editTask.id]; _id('btn-timer').innerText = "‚ñ∂Ô∏è";
            } else {
                activeTimers[editTask.id] = setInterval(() => { editTask.timeLog = (editTask.timeLog || 0) + 1; updateTimerDisplay(); }, 1000); _id('btn-timer').innerText = "‚è∏Ô∏è";
            }
        };
        const updateTimerDisplay = () => {
            const sec = editTask.timeLog || 0;
            const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60); const s = sec % 60;
            _id('m-timer-display').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        };

        const deleteTask = () => {
            undoStack = { task: editTask, col: editCol };
            boardData.columns[editCol] = boardData.columns[editCol].filter(t => t.id !== editTask.id);
            closeModals(); renderKanban();
            _id('toast-undo').style.display = 'flex';
            undoTimeout = setTimeout(() => { _id('toast-undo').style.display = 'none'; save(); }, 5000);
        };
        const undoAction = () => {
            clearTimeout(undoTimeout); boardData.columns[undoStack.col].push(undoStack.task); renderKanban(); _id('toast-undo').style.display = 'none';
        };

        // Context Menu
        const showContext = (e, task, col) => {
            e.preventDefault(); editTask = task; editCol = col;
            const menu = _id('context-menu'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
            return false;
        };
        window.onclick = () => _id('context-menu').style.display = 'none'; // Global close

        const duplicateTaskCtx = () => {
            const copy = {...editTask, id: Date.now().toString(), title: editTask.title + ' (Copia)'};
            boardData.columns[editCol].push(copy); save(); renderKanban();
        };
        const moveTaskCtx = (target) => {
            if(editCol === target) return;
            const t = boardData.columns[editCol].find(x => x.id === editTask.id);
            boardData.columns[editCol] = boardData.columns[editCol].filter(x => x.id !== editTask.id);
            boardData.columns[target].push(t);
            save(); renderKanban();
        };
        const deleteTaskCtx = () => { deleteTask(); };

        // Extras
        const filterCards = (q) => { document.querySelectorAll('.card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q.toLowerCase()) ? 'block' : 'none'); };
        const toggleTheme = () => {
            const html = document.documentElement; const curr = html.getAttribute('data-theme');
            html.setAttribute('data-theme', curr === 'dark' ? 'light' : 'dark');
            localStorage.setItem('theme', html.getAttribute('data-theme'));
        };
        const exportCSV = () => {
            let csv = "ID,Titulo,Columna,Asignado\n";
            for(let col in boardData.columns) { boardData.columns[col].forEach(t => csv += `${t.id},"${t.title}",${col},${t.assignedTo}\n`); }
            const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob); a.download = 'board.csv'; a.click();
        };
        const openStats = () => {
            let total = 0, done = 0;
            for(let c in boardData.columns) total += boardData.columns[c].length;
            done = boardData.columns['done'].length;
            _id('stats-content').innerHTML = `<p>Total: <b>${total}</b></p><p>Finalizado: <b>${done}</b></p><div class="progress-bar" style="height:20px;"><div class="progress-fill" style="width:${total?(done/total)*100:0}%"></div></div>`;
            _id('stats-modal').style.display = 'flex';
        };
        const toggleActivity = () => _id('activity-panel').classList.toggle('open');
        const renderActivityLog = () => { _id('activity-list').innerHTML = (boardData.activityLog||[]).map(l => `<div class="log-item">${l}</div>`).join(''); };
        
        const openShare = () => _id('share-modal').style.display='flex';
        const shareBoard = async () => { await updateDoc(doc(db,'boards',currentBoardId), {members: arrayUnion(_val('share-email'))}); closeModals(); };
        const softDeleteBoard = async () => { if(confirm("¬øPapelera?")) await updateDoc(doc(db,'boards',currentBoardId), {deleted:true}); };
        
        const openTrash = () => {
             onSnapshot(query(collection(db,'boards'), where('ownerId','==',currentUser.uid)), snap => {
                 let h = '';
                 snap.forEach(d => { if(d.data().deleted) h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${d.data().name}</span><button class="btn-primary" onclick="window.restore('${d.id}')">‚ôªÔ∏è</button></div>`; });
                 _id('trash-list').innerHTML = h || 'Vac√≠a';
                 _id('trash-modal').style.display='flex';
             });
        };
        const restore = async(id) => updateDoc(doc(db,'boards',id), {deleted:false});

        // Dashboard Init
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                initDashboard();
                if(localStorage.getItem('theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));
            }
        });

        const initDashboard = () => {
            onSnapshot(query(collection(db, 'boards'), where('ownerId', '==', currentUser.uid)), snap => {
                const div = _id('my-boards'); div.innerHTML = '';
                snap.forEach(d => { if(!d.data().deleted) div.innerHTML += renderBoardItem(d.id, d.data()); });
            });
            onSnapshot(query(collection(db, 'boards'), where('members', 'array-contains', currentUser.email)), snap => {
                const div = _id('shared-boards'); div.innerHTML = '';
                snap.forEach(d => { if(!d.data().deleted && d.data().ownerId !== currentUser.uid) div.innerHTML += renderBoardItem(d.id, d.data(), true); });
            });
        };
        const renderBoardItem = (id, data, shared) => `<div class="board-item" onclick="window.openBoard('${id}')"><span>${shared?'üë•':'üìÅ'} ${data.name}</span></div>`;

        // --- EXPOSE TO WINDOW ---
        // Asignamos las funciones locales al objeto window para que el HTML pueda verlas
        Object.assign(window, {
            login, register, logout,
            createBoard, openBoard, addTask,
            openTaskModal, updateTask, switchTab,
            addCheck, toggleCheck, addComment, addFile, toggleTimer, deleteTask,
            duplicateTaskCtx, moveTaskCtx, deleteTaskCtx, undoAction,
            filterCards, toggleTheme, exportCSV, openStats, toggleActivity,
            openShare, shareBoard, softDeleteBoard, openTrash, restore, closeModals,
            handleDrop // Importante para el Drag & Drop
        });

    </script>
</body>
</html>
