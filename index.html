<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Task v31 | AI Vision & Voice</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- ESTILOS CORE --- */
        :root {
            --primary: #0079bf; --bg: #ffffff; --sidebar: #f4f5f7; --surface: #ffffff;
            --text: #172b4d; --text-sub: #5e6c84; --border: #dfe1e6;
            --success: #61bd4f; --danger: #eb5a46; --warning: #ff9f1a;
            --shadow: 0 1px 2px rgba(0,0,0,0.15); --radius: 6px;
        }
        [data-theme="dark"] {
            --primary: #4a90e2; --bg: #1e1e1e; --sidebar: #252526; --surface: #2d2d30;
            --text: #e1e1e1; --text-sub: #a1a1a1; --border: #3e3e42;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); background: var(--bg); }
        
        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; }
        
        /* HEADER */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 20px; height: 55px; display: flex; align-items: center; justify-content: space-between; }
        
        /* KANBAN */
        .kanban { display: flex; padding: 20px; gap: 15px; overflow-x: auto; height: 100%; align-items: flex-start; }
        .list { background: var(--sidebar); width: 280px; min-width: 280px; border-radius: var(--radius); padding: 10px; max-height: 90%; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .list h4 { margin: 0 0 10px 5px; color: var(--text); font-weight: 700; }
        .cards { flex: 1; overflow-y: auto; min-height: 20px; padding-right: 4px; }
        
        .card { background: var(--surface); padding: 10px; margin-bottom: 10px; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); position: relative; }
        .card:hover { transform: translateY(-2px); }
        .card-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 5px; }
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 600; }
        .tag.urgent { background: var(--warning); }
        .tag.bug { background: var(--danger); }
        .card-meta { display: flex; gap: 8px; margin-top: 8px; font-size: 0.75rem; color: var(--text-sub); }

        /* UI ELEMENTS */
        input, select, textarea { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        
        /* --- FUTURISTIC UI (C√ÅMARA & CURSOR) --- */
        #webcam-container {
            position: fixed; bottom: 20px; right: 20px; width: 160px; height: 120px;
            background: black; border-radius: 10px; overflow: hidden; border: 2px solid var(--primary);
            z-index: 5000; display: none; transform: scaleX(-1); /* Espejo */
        }
        #webcam-feed { width: 100%; height: 100%; object-fit: cover; }
        
        /* Cursor Virtual (El punto rojo que sigues con el dedo) */
        #virtual-cursor {
            position: fixed; top: 0; left: 0; width: 20px; height: 20px;
            background: rgba(235, 90, 70, 0.7); border: 2px solid white;
            border-radius: 50%; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); display: none;
            box-shadow: 0 0 10px var(--danger);
        }
        #virtual-cursor.clicking { background: var(--success); transform: translate(-50%, -50%) scale(0.8); }

        /* Bot√≥n de Activar IA */
        .ai-toggle {
            position: fixed; bottom: 20px; right: 20px; 
            background: var(--text); color: var(--bg); 
            padding: 10px 20px; border-radius: 30px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 5001;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }

        /* Mic Button */
        .mic-btn { position: absolute; right: 5px; top: 5px; background: transparent; font-size: 1.2rem; }
        .input-group { position: relative; }
        .mic-active { color: var(--danger); animation: pulse 1s infinite; }

        /* Modales */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .box { background: var(--surface); padding: 25px; border-radius: 8px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .modal-lg { width: 700px; max-height: 90vh; overflow-y: auto; }
        
        /* Toast */
        #toast { position: fixed; top: 70px; right: 20px; background: #172b4d; color: white; padding: 15px; border-radius: 5px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 5000; }
        #toast.show { opacity: 1; pointer-events: auto; }
        
        /* Items Sidebar */
        .board-item { padding: 10px; margin-bottom: 4px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #172b4d; position: relative; transition: 0.2s; }
        .board-item.active { background: #e4f0f6; color: var(--primary); font-weight: 600; }
        .board-item.unread { background: #fff0f0; border-left: 3px solid var(--danger); }
        .badge-new { background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: auto; }

    </style>
</head>
<body>

    <div id="virtual-cursor"></div>
    
    <div id="webcam-container">
        <video id="webcam-feed" autoplay playsinline></video>
        <canvas id="output_canvas" style="display:none;"></canvas>
    </div>

    <button class="ai-toggle" onclick="toggleAI()">
        üëÅÔ∏è Activar Visi√≥n IA
    </button>

    <div id="toast" onclick="openToastBoard()">
        <strong id="toast-title">Notificaci√≥n</strong>
        <div id="toast-msg"></div>
    </div>

    <div id="auth-screen" class="overlay" style="background: var(--primary);">
        <div class="box">
            <h2 style="color:var(--primary); text-align:center;">Pro-Task v31</h2>
            <p style="text-align:center; color:gray;">Vision & Voice Edition</p>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="window.login()">Entrar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px;" onclick="window.register()">Registrarse</button>
            <p id="auth-msg" style="color:var(--danger); font-size:0.8rem; text-align:center;"></p>
        </div>
    </div>

    <div id="app-screen" class="app-container" style="display: none;">
        <div class="sidebar">
            <div style="padding:15px; font-weight:bold; color:var(--primary);">‚ö° PRO-TASK</div>
            <div style="padding:0 10px; font-size:0.75rem; color:var(--text-sub); font-weight:bold;">MIS PROYECTOS</div>
            <div id="my-boards" style="flex:1; overflow-y:auto; padding:10px;"></div>
            <div style="padding:0 10px; font-size:0.75rem; color:var(--text-sub); font-weight:bold;">COMPARTIDOS</div>
            <div id="shared-boards" style="max-height:150px; overflow-y:auto; padding:10px;"></div>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn-primary" style="width:100%;" onclick="window.createBoard()">+ Nuevo</button>
            </div>
        </div>

        <div class="main">
            <header>
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" placeholder="Buscar..." onkeyup="window.filterCards(this.value)">
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-ghost" onclick="window.toggleTheme()">üåì</button>
                    <span id="user-display" style="font-size:0.8rem; font-weight:bold;"></span>
                    <button class="btn-ghost" onclick="window.logout()">Salir</button>
                </div>
            </header>

            <div style="padding:10px 20px; display:flex; justify-content:space-between; align-items:center;">
                <h2 id="header-title" style="margin:0;">Tablero</h2>
                <div id="board-actions" style="display:none;">
                    <button class="btn-ghost" onclick="window.openShare()">üë§ Invitar</button>
                </div>
            </div>

            <div id="kanban" class="kanban"></div>
        </div>
    </div>

    <div id="task-modal" class="overlay" style="display: none;">
        <div class="box modal-lg">
            <span onclick="window.closeModals()" style="align-self:flex-end; cursor:pointer; font-size:1.5rem;">&times;</span>
            
            <div class="input-group">
                <input type="text" id="m-title" style="font-size:1.5rem; font-weight:bold; border:none; padding:5px 0; background:transparent;" placeholder="T√≠tulo" onblur="window.updateTask()">
                <button class="mic-btn" onclick="startDictation('m-title')">üé§</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:15px 0;">
                <div>
                    <label style="font-size:0.8rem; color:var(--text-sub);">Etiqueta</label>
                    <select id="m-tag" onchange="window.updateTask()">
                        <option value="">Ninguna</option>
                        <option value="urgent">üî• Urgente</option>
                        <option value="bug">üêõ Bug</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.8rem; color:var(--text-sub);">Vencimiento</label>
                    <input type="date" id="m-due" onchange="window.updateTask()">
                </div>
            </div>

            <label style="font-size:0.8rem; color:var(--text-sub);">Descripci√≥n (Dictado disponible)</label>
            <div class="input-group">
                <textarea id="m-desc" rows="3" onblur="window.updateTask()"></textarea>
                <button class="mic-btn" style="top:auto; bottom:5px;" onclick="startDictation('m-desc')">üé§</button>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn-danger" onclick="window.deleteTask()">Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="overlay" style="display:none;">
        <div class="box">
            <h3>Invitar Miembro</h3>
            <input id="share-email" placeholder="Email">
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="window.shareBoard()">Enviar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px;" onclick="window.closeModals()">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyAQnrIODc_2Qv_Snow02X-Sq8_PHwMoRVk",
            authDomain: "trello-d2532.firebaseapp.com",
            projectId: "trello-d2532",
            storageBucket: "trello-d2532.firebasestorage.app",
            messagingSenderId: "630892154656",
            appId: "1:630892154656:web:1d0dfce355216a1d879145"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app, "pro-task-app");

        let currentUser = null;
        let currentBoardId = null;
        let boardData = null;
        let editTask = null; 
        let editCol = null;
        let undoStack = null; let undoTimeout = null;

        // --- AUTH & CORE ---
        window.login = () => signInWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => _err(e.message));
        window.register = () => createUserWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => _err(e.message));
        window.logout = () => { signOut(auth); location.reload(); };

        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                initDashboard();
            }
        });

        // --- DASHBOARD ---
        function initDashboard() {
            onSnapshot(query(collection(db, 'boards'), where('ownerId', '==', currentUser.uid)), snap => {
                const div = document.getElementById('my-boards'); div.innerHTML = '';
                snap.forEach(d => { if(!d.data().deleted) div.innerHTML += renderBoardItem(d.id, d.data()); });
            });
            onSnapshot(query(collection(db, 'boards'), where('members', 'array-contains', currentUser.email)), snap => {
                const div = document.getElementById('shared-boards'); div.innerHTML = '';
                snap.forEach(d => { if(!d.data().deleted && d.data().ownerId !== currentUser.uid) div.innerHTML += renderBoardItem(d.id, d.data(), true); });
            });
        }
        const renderBoardItem = (id, data, shared) => `<div class="board-item" onclick="window.openBoard('${id}')"><span>${shared?'üë•':'üìÅ'} ${data.name}</span></div>`;

        window.createBoard = async () => {
            const name = prompt("Nombre:"); if(!name) return;
            const res = await addDoc(collection(db, 'boards'), {
                name, ownerId: currentUser.uid, members: [currentUser.email],
                deleted: false, createdAt: serverTimestamp(), columns: { todo: [], doing: [], done: [] }
            });
            openBoard(res.id);
        };

        window.openBoard = (id) => {
            currentBoardId = id;
            onSnapshot(doc(db, 'boards', id), snap => {
                if(!snap.exists() || snap.data().deleted) return document.getElementById('kanban').innerHTML = '<p>No disponible</p>';
                boardData = snap.data();
                document.getElementById('header-title').innerText = boardData.name;
                document.getElementById('board-actions').style.display = (boardData.ownerId === currentUser.uid) ? 'block' : 'none';
                renderKanban();
            });
        };

        // --- KANBAN ---
        function renderKanban() {
            const container = document.getElementById('kanban'); container.innerHTML = '';
            const cols = { todo: "Por Hacer", doing: "En Progreso", done: "Finalizado" };
            for (let k in cols) {
                const list = document.createElement('div'); list.className = 'list';
                const cardCont = document.createElement('div'); cardCont.className = 'cards';
                cardCont.id = k;
                cardCont.ondragover = e => e.preventDefault();
                cardCont.ondrop = e => handleDrop(e, k);
                (boardData.columns[k] || []).forEach(task => cardCont.appendChild(createCard(task, k)));
                list.innerHTML = `<h4>${cols[k]} <span>${(boardData.columns[k]||[]).length}</span></h4>`;
                list.appendChild(cardCont);
                list.innerHTML += `<button class="btn-ghost" style="width:100%; text-align:left;" onclick="window.addTask('${k}')">+ A√±adir</button>`;
                container.appendChild(list);
            }
        }

        const createCard = (task, col) => {
            const el = document.createElement('div'); el.className = 'card'; el.draggable = true;
            el.ondragstart = e => e.dataTransfer.setData('text', JSON.stringify({id: task.id, src: col}));
            el.onclick = () => openTaskModal(task, col);
            let html = `<div class="card-content">`;
            if(task.tag) html += `<div class="card-tags"><span class="tag ${task.tag}">${task.tag.toUpperCase()}</span></div>`;
            html += `<strong>${task.title}</strong>`;
            html += `<div class="card-meta">`;
            if(task.due) html += `<span>üìÖ ${task.due.slice(5)}</span>`;
            html += `</div></div>`;
            el.innerHTML = html;
            return el;
        };

        window.addTask = (col) => {
            const t = prompt("Tarea:"); if(!t) return;
            const newTask = { id: Date.now().toString(), title: t, desc: '', tag: '', due: '' };
            boardData.columns[col].push(newTask); save();
        };

        window.handleDrop = (e, dest) => {
            e.preventDefault(); const data = e.dataTransfer.getData('text'); if(!data) return;
            const {id, src} = JSON.parse(data); if(src === dest) return;
            const idx = boardData.columns[src].findIndex(t => t.id === id);
            const [task] = boardData.columns[src].splice(idx, 1);
            boardData.columns[dest].push(task); save();
        };

        async function save() { await updateDoc(doc(db, 'boards', currentBoardId), { columns: boardData.columns }); }

        window.openTaskModal = (task, col) => {
            editTask = task; editCol = col;
            document.getElementById('task-modal').style.display = 'flex';
            _id('m-title').value = task.title; _id('m-desc').value = task.desc || '';
            _id('m-due').value = task.due || ''; _id('m-tag').value = task.tag || '';
        };

        window.updateTask = () => {
            if(!editTask) return;
            editTask.title = _id('m-title').value; editTask.desc = _id('m-desc').value;
            editTask.due = _id('m-due').value; editTask.tag = _id('m-tag').value;
            save();
        };

        window.deleteTask = () => {
            if(!confirm("¬øEliminar?")) return;
            boardData.columns[editCol] = boardData.columns[editCol].filter(t => t.id !== editTask.id);
            window.closeModals(); renderKanban(); save();
        };

        // --- UTILS ---
        window._id = (x) => document.getElementById(x);
        function _val(x) { return document.getElementById(x).value; }
        function _err(msg) { document.getElementById('auth-msg').innerText = msg; }
        window.closeModals = () => document.querySelectorAll('.overlay').forEach(e => { if(e.id!=='auth-screen') e.style.display='none'; });
        window.openShare = () => _id('share-modal').style.display='flex';
        window.shareBoard = async () => { await updateDoc(doc(db,'boards',currentBoardId), {members: arrayUnion(_val('share-email'))}); window.closeModals(); };
        window.toggleTheme = () => {
            const h = document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark');
        };
        window.filterCards = (q) => document.querySelectorAll('.card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q.toLowerCase()) ? 'block' : 'none');
        
        // --- üé§ VOICE ASSISTANT ---
        window.startDictation = (inputId) => {
            if (!('webkitSpeechRecognition' in window)) return alert("Tu navegador no soporta voz.");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = "es-ES";
            const btn = document.querySelector(`button[onclick="startDictation('${inputId}')"]`);
            btn.classList.add('mic-active');
            
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                const field = document.getElementById(inputId);
                field.value += (field.value ? " " : "") + text;
                window.updateTask(); // Auto-save
                btn.classList.remove('mic-active');
            };
            recognition.onerror = () => btn.classList.remove('mic-active');
            recognition.start();
        };

        // --- üëÅÔ∏è COMPUTER VISION (MEDIAPIPE) ---
        let camera = null;
        let isAiActive = false;
        
        window.toggleAI = () => {
            const container = document.getElementById('webcam-container');
            const cursor = document.getElementById('virtual-cursor');
            
            if(isAiActive) {
                if(camera) camera.stop();
                container.style.display = 'none';
                cursor.style.display = 'none';
                isAiActive = false;
                return;
            }

            container.style.display = 'block';
            cursor.style.display = 'block';
            isAiActive = true;
            initHands();
        };

        async function initHands() {
            const videoElement = document.getElementById('webcam-feed');
            
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });
            
            hands.onResults(onResults);
            
            camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 320, height: 240
            });
            camera.start();
        }

        let isPinching = false;
        let pinchStart = 0;

        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
            
            const landmarks = results.multiHandLandmarks[0];
            const indexTip = landmarks[8];
            const thumbTip = landmarks[4];

            // 1. Mover Cursor (Espejo horizontal)
            const x = (1 - indexTip.x) * window.innerWidth;
            const y = indexTip.y * window.innerHeight;
            
            const cursor = document.getElementById('virtual-cursor');
            cursor.style.left = `${x}px`;
            cursor.style.top = `${y}px`;

            // 2. Detectar Pinza (Click)
            const distance = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
            const PINCH_THRESHOLD = 0.05; 

            if (distance < PINCH_THRESHOLD) {
                if (!isPinching) {
                    isPinching = true;
                    cursor.classList.add('clicking');
                    // Trigger Click
                    const el = document.elementFromPoint(x, y);
                    if(el) el.click();
                }
            } else {
                if (isPinching) {
                    isPinching = false;
                    cursor.classList.remove('clicking');
                }
            }
        }
    </script>
</body>
</html>
