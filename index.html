<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pro-Task Enterprise v9.5 | Stable Cloud System</title>
    <style>
        /* CSS MAESTRO - DISE√ëO Y FUNCIONALIDAD */
        :root {
            --bg-main: #0079bf; --bg-list: #ebecf0; --text-main: #172b4d;
            --card-bg: #ffffff; --accent: #5aac44; --error: #eb5a46; --sidebar: #f4f5f7;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-main); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* Estructura */
        .main-wrapper { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 10; transition: 0.3s; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 0.85rem; color: #5e6c84; letter-spacing: 0.5px; }
        .folder-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .folder-item { padding: 10px 15px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #172b4d; }
        .folder-item:hover { background: rgba(9,30,66,0.08); }
        .folder-item.active { background: #e4f0f6; color: #0079bf; font-weight: bold; }

        .content-area { flex-grow: 1; display: flex; flex-direction: column; position: relative; background: white; }
        
        /* Header y Kanban */
        header { background: var(--bg-main); padding: 10px 20px; color: white; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        .board-canvas { display: flex; padding: 20px; gap: 20px; overflow-x: auto; height: 100%; align-items: flex-start; background: #ffffff; }
        
        .list { background: var(--bg-list); width: 300px; min-width: 300px; border-radius: 10px; padding: 12px; max-height: 90%; display: flex; flex-direction: column; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .cards-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; min-height: 20px; }
        
        /* Tarjetas */
        .card { background: var(--card-bg); padding: 12px; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); cursor: grab; border-left: 5px solid #dfe1e6; font-size: 0.95rem; }
        .card:hover { background: #f4f5f7; }
        .card.high { border-left-color: var(--error); }
        .card.medium { border-left-color: #f2d600; }
        .card.low { border-left-color: var(--success); }

        /* Modal & Scroll */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 20px; }
        .modal-content { background: #f4f5f7; margin: auto; width: 100%; max-width: 650px; max-height: 90vh; border-radius: 8px; overflow: hidden; position: relative; color: #333; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .modal-body-scroll { padding: 30px; max-height: calc(90vh - 60px); overflow-y: auto; }

        /* Pantallas de Carga/Auth */
        .auth-overlay { position: fixed; inset: 0; background: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .auth-card { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .btn-primary { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-danger { background: var(--error); color: white; border: none; padding: 10px; border-radius: 4px; width: 100%; cursor: pointer; margin-top: 20px; }
        
        /* Checklists */
        .progress-bar { background: #dfe1e6; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        #progress-fill { background: var(--accent); height: 100%; width: 0%; transition: 0.3s; }
    </style>
</head>
<body>

    <div id="auth-container" class="auth-overlay">
        <div class="auth-card">
            <h2 style="color:var(--bg-main)">Pro-Task Enterprise</h2>
            <p>Espacio de Trabajo Seguro</p>
            <input type="email" id="login-email" placeholder="Email corporativo">
            <input type="password" id="login-pass" placeholder="Contrase√±a">
            <button id="btn-login" class="btn-primary" style="margin-top:10px;">Entrar</button>
            <button id="btn-signup" style="background:none; border:none; color:var(--bg-main); cursor:pointer; margin-top:15px; text-decoration:underline;">Crear cuenta nueva</button>
        </div>
    </div>

    <div id="loading-screen" class="auth-overlay" style="display: none; background: rgba(255,255,255,0.95); z-index: 6000;">
        <div class="auth-card" style="box-shadow:none; background:transparent;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--bg-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            <h3>Cargando proyecto...</h3>
            <p id="loading-text" style="font-size:0.8rem; color:#666;">Conectando con la nube segura</p>
            <button onclick="window.forceUnlock()" style="margin-top:20px; font-size:0.8rem; background:#ccc; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">Cancelar carga</button>
        </div>
    </div>

    <div id="app-container" class="main-wrapper" style="display: none;">
        
        <aside class="sidebar">
            <div class="sidebar-header">MIS PROYECTOS</div>
            <div id="user-folders" class="folder-list"></div>
            
            <div class="sidebar-header" style="border-top:1px solid #ddd">COMPARTIDOS CONMIGO</div>
            <div id="shared-folders" class="folder-list"></div>
            
            <div style="padding:20px;">
                <button onclick="window.createNewFolder()" class="btn-primary" style="background:var(--bg-main)">+ Nuevo Proyecto</button>
            </div>
        </aside>

        <div class="content-area">
            <header>
                <div style="display:flex; align-items:center; gap:15px;">
                    <h2 id="current-folder-name" style="margin:0; font-size:1.2rem;">Selecciona o crea un proyecto</h2>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="email" id="share-email" placeholder="Invitar usuario..." style="padding:6px; border-radius:4px; border:none;">
                    <button onclick="window.shareCurrentFolder()" style="background:rgba(255,255,255,0.2); color:white; border:1px solid white; padding:6px 12px; border-radius:4px; cursor:pointer;">Compartir</button>
                    <button id="btn-logout" style="background:none; color:white; border:1px solid white; cursor:pointer; padding:6px 10px; border-radius:4px;">Salir</button>
                </div>
            </header>

            <main class="board-canvas" id="kanban-board">
                <div style="padding:50px; text-align:center; color:#888; width:100%;">
                    <h3>‚Üê Selecciona un proyecto en la barra lateral</h3>
                    <p>O crea uno nuevo para empezar</p>
                </div>
            </main>
        </div>
    </div>

    <div id="card-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal()" style="position:absolute; right:20px; top:15px; cursor:pointer; font-size:24px;">&times;</span>
            <div class="modal-body-scroll">
                <input type="text" id="modal-title" style="width:100%; font-size:1.8rem; font-weight:bold; border:none; background:transparent; outline:none; margin-bottom:20px;">
                
                <h4 style="margin-top:0;">Prioridad</h4>
                <select id="modal-priority" onchange="window.updatePriority()" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd;">
                    <option value="low">Baja (Normal)</option>
                    <option value="medium">Media (Atenci√≥n)</option>
                    <option value="high">Alta (Urgente)</option>
                </select>

                <h4 style="margin-top:20px;">Descripci√≥n</h4>
                <textarea id="modal-desc" style="width:100%; height:100px; padding:10px; border-radius:5px; border:1px solid #ddd; resize:none;"></textarea>

                <h4 style="margin-top:20px;">Checklist <span id="check-percent" style="float:right; font-size:0.9rem;">0%</span></h4>
                <div class="progress-bar"><div id="progress-fill"></div></div>
                <div id="modal-checklist"></div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="new-check-input" placeholder="Nueva sub-tarea..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    <button onclick="window.addChecklistItem()" class="btn-primary" style="width:auto; padding:0 20px;">+</button>
                </div>

                <button onclick="window.deleteCard()" class="btn-danger">Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, addDoc, updateDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // CONFIGURACI√ìN (Tus Credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyAQnrIODc_2Qv_Snow02X-Sq8_PHwMoRVk",
            authDomain: "trello-d2532.firebaseapp.com",
            projectId: "trello-d2532",
            storageBucket: "trello-d2532.firebasestorage.app",
            messagingSenderId: "630892154656",
            appId: "1:630892154656:web:1d0dfce355216a1d879145"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeFolderId = localStorage.getItem('lastFolderId') || null;
        let folderData = null;
        let unsubscribe = null;
        let isSyncReady = false;

        // AUTHENTICATION
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e => alert("Error: " + e.message));
        document.getElementById('btn-signup').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e => alert("Error: " + e.message));
        document.getElementById('btn-logout').onclick = () => { localStorage.clear(); signOut(auth); };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                loadUserSpace();
                // Intento de recuperaci√≥n de sesi√≥n
                if(activeFolderId) openFolder(activeFolderId); 
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // --- SISTEMA DE CARPETAS ---
        function loadUserSpace() {
            const foldersRef = collection(db, "users", currentUser.uid, "boards");
            onSnapshot(foldersRef, snap => {
                const cont = document.getElementById('user-folders');
                cont.innerHTML = '';
                snap.forEach(d => {
                    const item = document.createElement('div');
                    item.className = `folder-item ${d.id === activeFolderId ? 'active' : ''}`;
                    item.innerHTML = `üìÅ ${d.data().name}`;
                    item.onclick = () => openFolder(d.id);
                    cont.appendChild(item);
                });
            });

            // Compartidos (Simplified for stability)
            const sharedQuery = query(collectionGroup(db, "boards"), where("collaborators", "array-contains", currentUser.email.toLowerCase()));
            onSnapshot(sharedQuery, snap => {
                const cont = document.getElementById('shared-folders');
                cont.innerHTML = '';
                snap.forEach(d => {
                    const item = document.createElement('div');
                    item.className = `folder-item ${d.id === activeFolderId ? 'active' : ''}`;
                    item.innerHTML = `ü§ù ${d.data().name}`;
                    // Para compartidos necesitamos saber qui√©n es el due√±o real, aqu√≠ lo extraemos de la referencia
                    const ownerId = d.ref.parent.parent.id; 
                    item.onclick = () => openFolder(d.id, ownerId); 
                    cont.appendChild(item);
                });
            });
        }

        window.createNewFolder = async () => {
            const name = prompt("Nombre del Proyecto:");
            if(!name) return;
            const newProject = {
                name: name,
                owner: currentUser.uid,
                collaborators: [],
                data: { todo: [], 'in-progress': [], done: [] }
            };
            const docRef = await addDoc(collection(db, "users", currentUser.uid, "boards"), newProject);
            openFolder(docRef.id);
        };

        // --- APERTURA DE CARPETA (CON RESCATE DE ERROR) ---
        function openFolder(boardId, ownerId = currentUser.uid) {
            if(unsubscribe) unsubscribe();
            isSyncReady = false;
            activeFolderId = boardId;
            localStorage.setItem('lastFolderId', boardId);
            document.getElementById('loading-screen').style.display = 'flex';

            // TIMER DE SEGURIDAD: Si en 4 segundos no carga, abortar.
            const safetyTimer = setTimeout(() => {
                if(!isSyncReady) window.forceUnlock();
            }, 4000);

            unsubscribe = onSnapshot(doc(db, "users", ownerId, "boards", boardId), snap => {
                clearTimeout(safetyTimer); // Cancelar timer si carg√≥ bien
                if(!snap.exists()) {
                    window.forceUnlock(); // Si el documento no existe (borrado), desbloquear
                    return;
                }
                folderData = snap.data();
                // Guardamos el ID del due√±o actual en el objeto para usarlos al guardar
                folderData.currentOwnerId = ownerId; 
                
                isSyncReady = true;
                document.getElementById('current-folder-name').innerText = folderData.name;
                renderKanban();
                document.getElementById('loading-screen').style.display = 'none';
                
                // Actualizar UI de lista activa
                document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('active'));
                // Nota: La actualizaci√≥n visual de "active" se hace al repintar la lista en loadUserSpace
            });
        }

        // Funci√≥n para desbloquear si se queda pegado
        window.forceUnlock = () => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('kanban-board').innerHTML = '<div style="padding:50px; text-align:center; color:#666;"><h3>No se pudo cargar el proyecto</h3><p>Es posible que haya sido eliminado o no tengas permiso.</p></div>';
            localStorage.removeItem('lastFolderId');
            activeFolderId = null;
        };

        // --- KANBAN ---
        function renderKanban() {
            const canvas = document.getElementById('kanban-board');
            canvas.innerHTML = '';
            ['todo', 'in-progress', 'done'].forEach(col => {
                const list = document.createElement('div');
                list.className = 'list';
                list.innerHTML = `<h3>${col.toUpperCase()}</h3><div class="cards-container"></div>`;
                const container = list.querySelector('.cards-container');
                
                (folderData.data[col] || []).forEach(card => {
                    const cEl = document.createElement('div');
                    cEl.className = `card ${card.priority || 'low'}`;
                    cEl.innerHTML = `<strong>${card.title}</strong>`;
                    cEl.onclick = () => openModal(card.id);
                    container.appendChild(cEl);
                });

                const addBtn = document.createElement('div');
                addBtn.style.marginTop = "10px";
                addBtn.innerHTML = `<input type="text" placeholder="+ Tarea" style="width:100%; padding:8px; box-sizing:border-box; border-radius:4px; border:1px solid #ddd; margin-bottom:5px;"><button onclick="window.addTask('${col}', this)" class="btn-primary">A√±adir</button>`;
                list.appendChild(addBtn);
                canvas.appendChild(list);
            });
        }

        async function safeUpdate() {
            if(!isSyncReady || !folderData) return;
            // Usamos el ID del due√±o que guardamos al abrir, o el actual si es propio
            const targetOwner = folderData.currentOwnerId || currentUser.uid;
            await updateDoc(doc(db, "users", targetOwner, "boards", activeFolderId), { 
                data: folderData.data, 
                collaborators: folderData.collaborators || [] 
            });
        }

        window.addTask = (col, btn) => {
            const input = btn.previousElementSibling; if(!input.value) return;
            folderData.data[col].push({ id: 'c'+Date.now(), title: input.value, priority: 'low', checklist: [], desc: '' });
            input.value = ''; renderKanban(); safeUpdate();
        };

        window.shareCurrentFolder = () => {
            const email = document.getElementById('share-email').value.toLowerCase().trim();
            if(!email) return;
            if(!folderData.collaborators) folderData.collaborators = [];
            if(!folderData.collaborators.includes(email)) {
                folderData.collaborators.push(email);
                safeUpdate();
                alert("Invitaci√≥n enviada a " + email);
            }
        };

        // --- MODAL ---
        let currentEditingId = null;
        function openModal(id) {
            currentEditingId = id; const card = findCard(id);
            document.getElementById('modal-title').value = card.title;
            document.getElementById('modal-desc').value = card.desc || '';
            document.getElementById('modal-priority').value = card.priority || 'low';
            renderChecklist(card);
            document.getElementById('card-modal').style.display = 'block';
        }
        function findCard(id) { return [...folderData.data.todo, ...folderData.data['in-progress'], ...folderData.data.done].find(c => c.id === id); }
        window.closeModal = () => document.getElementById('card-modal').style.display = 'none';

        window.updatePriority = () => { findCard(currentEditingId).priority = document.getElementById('modal-priority').value; renderKanban(); safeUpdate(); };
        
        window.addChecklistItem = () => {
            const card = findCard(currentEditingId); card.checklist = card.checklist || [];
            card.checklist.push({ text: document.getElementById('new-check-input').value, done: false });
            document.getElementById('new-check-input').value = ''; renderChecklist(card); safeUpdate();
        };
        function renderChecklist(card) {
            const cont = document.getElementById('modal-checklist');
            cont.innerHTML = (card.checklist || []).map((it, i) => `<div><input type="checkbox" ${it.done ? 'checked' : ''} onchange="window.toggleCheck(${i})"> ${it.text}</div>`).join('');
            const done = (card.checklist || []).filter(x => x.done).length;
            const pc = card.checklist?.length ? Math.round((done/card.checklist.length)*100) : 0;
            document.getElementById('progress-fill').style.width = pc+'%';
            document.getElementById('check-percent').innerText = pc+'%';
        }
        window.toggleCheck = (i) => { const card = findCard(currentEditingId); card.checklist[i].done = !card.checklist[i].done; renderChecklist(card); safeUpdate(); };
        
        window.deleteCard = () => { 
            if(!confirm("¬øEliminar?")) return; 
            ['todo','in-progress','done'].forEach(c => folderData.data[c] = folderData.data[c].filter(x => x.id !== currentEditingId)); 
            window.closeModal(); renderKanban(); safeUpdate(); 
        };

        document.getElementById('modal-title').onblur = e => { findCard(currentEditingId).title = e.target.value; renderKanban(); safeUpdate(); };
        document.getElementById('modal-desc').onblur = e => { findCard(currentEditingId).desc = e.target.value; safeUpdate(); };
    </script>
</body>
</html>
