<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pro-Task Cloud v7.0 | Multi-Board System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="light-theme">

    <div id="auth-container" class="auth-overlay">
        <div class="auth-card">
            <h2>Pro-Task Enterprise</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Contraseña">
            <button id="btn-login" class="btn-primary" style="margin-top:10px;">Entrar</button>
            <button id="btn-signup" style="background:none; border:none; color:var(--bg-main); cursor:pointer; margin-top:10px;">Crear cuenta</button>
        </div>
    </div>

    <div id="app-container" class="main-wrapper" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">Mis Proyectos</div>
            <div id="my-boards" class="board-list"></div>
            
            <div class="sidebar-header" style="border-top:1px solid #ddd">Compartidos conmigo</div>
            <div id="shared-boards" class="board-list"></div>
            
            <div style="padding:20px;">
                <button onclick="window.createNewBoard()" class="btn-primary" style="background:#0079bf">+ Nuevo Tablero</button>
            </div>
        </aside>

        <div class="content-area">
            <header>
                <div style="display:flex; align-items:center; gap:15px;">
                    <h2 id="current-board-name" style="margin:0;">Selecciona un tablero</h2>
                    <span id="user-display" style="font-size:0.8rem; opacity:0.7;"></span>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="email" id="share-email" placeholder="Invitar correo..." style="border-radius:3px; border:none; padding:5px;">
                    <button onclick="window.shareBoard()" class="btn-share">Compartir</button>
                    <button id="btn-logout" class="btn-logout-mini" style="background:none; color:white; border:1px solid white; cursor:pointer;">Salir</button>
                </div>
            </header>

            <main class="board" id="kanban-board">
                </main>
        </div>
    </div>

    <div id="card-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal()" style="position:absolute; right:20px; top:15px; cursor:pointer; font-size:20px;">&times;</span>
            <div class="modal-body-scroll">
                <input type="text" id="modal-title" style="width:100%; font-size:1.5rem; font-weight:bold; border:none;">
                <h4>Prioridad</h4>
                <select id="modal-priority" onchange="window.updatePriority()" style="width:100%; padding:8px;">
                    <option value="low">Baja</option>
                    <option value="medium">Media</option>
                    <option value="high">Alta</option>
                </select>
                <h4>Descripción</h4>
                <textarea id="modal-desc" style="width:100%; height:100px; padding:10px;"></textarea>
                <button onclick="window.archiveCard()" class="btn-danger" style="margin-top:20px;">Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-engine.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { collection, query, where, onSnapshot, doc, setDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let currentBoardId = localStorage.getItem('lastBoardId') || null;
        let boardData = null;
        let currentUser = null;
        let unsubscribeBoard = null;

        // --- AUTENTICACIÓN ---
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
        document.getElementById('btn-signup').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
        document.getElementById('btn-logout').onclick = () => { localStorage.clear(); signOut(auth); };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                loadBoardList();
                if(currentBoardId) selectBoard(currentBoardId);
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // --- GESTIÓN DE TABLEROS (LA MEMORIA) ---
        function loadBoardList() {
            // Tableros propios
            const qOwn = query(collection(db, "boards"), where("owner", "==", currentUser.uid));
            onSnapshot(qOwn, snap => {
                renderList(snap, 'my-boards');
            });

            // Tableros compartidos
            const qShared = query(collection(db, "boards"), where("collaborators", "array-contains", currentUser.email.toLowerCase()));
            onSnapshot(qShared, snap => {
                renderList(snap, 'shared-boards');
            });
        }

        function renderList(snap, containerId) {
            const cont = document.getElementById(containerId);
            cont.innerHTML = '';
            snap.forEach(doc => {
                const item = document.createElement('div');
                item.className = `board-item ${doc.id === currentBoardId ? 'active' : ''}`;
                item.innerText = doc.data().name;
                item.onclick = () => selectBoard(doc.id);
                cont.appendChild(item);
            });
        }

        window.createNewBoard = async () => {
            const name = prompt("Nombre del nuevo tablero:");
            if(!name) return;
            const newBoard = {
                name: name,
                owner: currentUser.uid,
                collaborators: [],
                data: { todo: [], 'in-progress': [], done: [] }
            };
            const docRef = await addDoc(collection(db, "boards"), newBoard);
            selectBoard(docRef.id);
        };

        function selectBoard(id) {
            if(unsubscribeBoard) unsubscribeBoard();
            currentBoardId = id;
            localStorage.setItem('lastBoardId', id);
            
            unsubscribeBoard = onSnapshot(doc(db, "boards", id), snap => {
                if(!snap.exists()) return;
                boardData = snap.data();
                document.getElementById('current-board-name').innerText = boardData.name;
                renderKanban();
            });
        }

        // --- LÓGICA KANBAN ---
        function renderKanban() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';
            ['todo', 'in-progress', 'done'].forEach(colId => {
                const list = document.createElement('div');
                list.className = 'list';
                list.dataset.id = colId;
                list.innerHTML = `<h3>${colId.toUpperCase()}</h3><div class="cards-container"></div>`;
                
                const cardsCont = list.querySelector('.cards-container');
                (boardData.data[colId] || []).forEach(card => {
                    const cEl = document.createElement('div');
                    cEl.className = `card ${card.priority}`;
                    cEl.innerText = card.title;
                    cEl.onclick = () => openModal(card.id);
                    cardsCont.appendChild(cEl);
                });

                // Botón añadir
                const addBox = document.createElement('div');
                addBox.innerHTML = `<input type="text" class="card-input" placeholder="+"><button onclick="window.addCard('${colId}', this)">+</button>`;
                list.appendChild(addBox);
                board.appendChild(list);
            });
        }

        window.addCard = async (col, btn) => {
            const input = btn.previousElementSibling;
            if(!input.value) return;
            const card = { id: 'c'+Date.now(), title: input.value, priority: 'low' };
            boardData.data[col].push(card);
            await setDoc(doc(db, "boards", currentBoardId), boardData);
        };

        window.shareBoard = async () => {
            const email = document.getElementById('share-email').value.toLowerCase();
            if(!boardData.collaborators.includes(email)) {
                boardData.collaborators.push(email);
                await setDoc(doc(db, "boards", currentBoardId), boardData);
                alert("Compartido con éxito");
            }
        };

        window.closeModal = () => document.getElementById('card-modal').style.display='none';
    </script>
</body>
</html>
