<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pro-Task Cloud v8.5 | Professional Edition</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="light-theme">

    <div id="auth-container" class="auth-overlay">
        <div class="auth-card">
            <h2>Pro-Task Enterprise</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <button id="btn-login" class="btn-primary" style="margin-top:10px;">Entrar</button>
            <button id="btn-signup" style="background:none; border:none; color:var(--bg-main); cursor:pointer; margin-top:20px; text-decoration:underline;">Crear Cuenta</button>
            <p id="auth-error" style="color:var(--error); font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="loading-screen" class="auth-overlay" style="display: none; background: rgba(255,255,255,0.95); z-index: 6000;">
        <div class="auth-card" style="box-shadow:none; background:transparent;">
            <h3>Sincronizando memoria segura...</h3>
        </div>
    </div>

    <div id="app-container" class="main-wrapper" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">üìÇ MIS PROYECTOS</div>
            <div id="my-boards" class="board-list"></div>
            <div class="sidebar-header" style="border-top:1px solid #ddd">ü§ù COMPARTIDOS</div>
            <div id="shared-boards" class="board-list"></div>
            <div style="padding:20px;"><button onclick="window.createNewBoard()" class="btn-primary">+ Nueva Carpeta</button></div>
        </aside>

        <div class="content-area">
            <header>
                <h2 id="current-board-name" style="margin:0;">Selecciona un Tablero</h2>
                <div style="display:flex; gap:12px; align-items:center;">
                    <input type="email" id="share-email" placeholder="Invitar por email..." style="border-radius:4px; padding:8px; border:none;">
                    <button onclick="window.shareBoard()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">Compartir</button>
                    <button id="btn-logout" style="background:none; color:white; border:1px solid white; cursor:pointer; padding:6px 10px; border-radius:4px;">Cerrar Sesi√≥n</button>
                </div>
            </header>
            <main class="board-canvas" id="kanban-board"></main>
        </div>
    </div>

    <div id="card-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal()">&times;</span>
            <div class="modal-body-scroll">
                <input type="text" id="modal-title" style="width:100%; font-size:1.8rem; font-weight:bold; border:none; background:transparent; outline:none; margin-bottom:20px;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <h4>Prioridad</h4>
                        <select id="modal-priority" onchange="window.updatePriority()" style="width:100%; padding:10px; border-radius:6px;">
                            <option value="low">Baja (Verde)</option>
                            <option value="medium">Media (Amarillo)</option>
                            <option value="high">Alta (Rojo)</option>
                        </select>
                    </div>
                    <div>
                        <h4>Responsables</h4>
                        <div id="modal-members" style="display:flex; gap:5px;"></div>
                    </div>
                </div>

                <h4>Descripci√≥n</h4>
                <textarea id="modal-desc" style="width:100%; height:100px; padding:12px; border-radius:6px; border:1px solid #ddd;"></textarea>

                <h4>Checklist <span id="check-percent" style="float:right;">0%</span></h4>
                <div class="progress-bar"><div id="progress-fill"></div></div>
                <div id="modal-checklist"></div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input type="text" id="new-check-input" placeholder="A√±adir paso..." style="flex:1; padding:8px;">
                    <button onclick="window.addChecklistItem()" class="btn-primary" style="width:auto; padding:0 20px;">+</button>
                </div>

                <button onclick="window.archiveCard()" style="background:var(--error); color:white; border:none; padding:12px; border-radius:6px; width:100%; cursor:pointer; font-weight:bold; margin-top:25px;">Eliminar Permanentemente</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-engine.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { collection, query, where, onSnapshot, doc, setDoc, addDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let currentBoardId = localStorage.getItem('lastActiveBoard') || null;
        let boardData = null;
        let currentUser = null;
        let unsubscribeBoard = null;
        let isDataReady = false; // EL CANDADO DE SEGURIDAD

        // --- AUTH ---
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e => alert(e.message));
        document.getElementById('btn-signup').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e => alert(e.message));
        document.getElementById('btn-logout').onclick = () => { localStorage.clear(); signOut(auth); };

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Asegurar ficha de usuario en DB
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if(!snap.exists()) await setDoc(userRef, { email: user.email, lastBoard: null });

                loadBoardList(); 
                if(currentBoardId) selectBoard(currentBoardId);
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // --- MANEJO DE TABLEROS ("CARPETAS") ---
        function loadBoardList() {
            onSnapshot(query(collection(db, "boards"), where("owner", "==", currentUser.uid)), snap => renderNav(snap, 'my-boards'));
            onSnapshot(query(collection(db, "boards"), where("collaborators", "array-contains", currentUser.email.toLowerCase())), snap => renderNav(snap, 'shared-boards'));
        }

        function renderNav(snap, id) {
            const cont = document.getElementById(id); cont.innerHTML = '';
            snap.forEach(d => {
                const div = document.createElement('div');
                div.className = `board-item ${d.id === currentBoardId ? 'active' : ''}`;
                div.innerText = "üìÅ " + d.data().name;
                div.onclick = () => selectBoard(d.id);
                cont.appendChild(div);
            });
        }

        window.createNewBoard = async () => {
            const name = prompt("Nombre del proyecto:");
            if(!name) return;
            const docRef = await addDoc(collection(db, "boards"), {
                name, owner: currentUser.uid, collaborators: [], data: { todo: [], 'in-progress': [], done: [] }
            });
            selectBoard(docRef.id);
        };

        function selectBoard(id) {
            if(unsubscribeBoard) unsubscribeBoard();
            isDataReady = false; 
            currentBoardId = id;
            localStorage.setItem('lastActiveBoard', id);
            document.getElementById('loading-screen').style.display = 'flex';

            unsubscribeBoard = onSnapshot(doc(db, "boards", id), snap => {
                if(!snap.exists()) {
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }
                boardData = snap.data();
                isDataReady = true; // ABRE EL CANDADO
                document.getElementById('current-board-name').innerText = boardData.name;
                renderKanban();
                document.getElementById('loading-screen').style.display = 'none';
            });
        }

        // --- KANBAN ---
        function renderKanban() {
            const canvas = document.getElementById('kanban-board'); canvas.innerHTML = '';
            ['todo', 'in-progress', 'done'].forEach(col => {
                const div = document.createElement('div'); div.className = 'list';
                div.innerHTML = `<h3>${col.toUpperCase()}</h3><div class="cards-container"></div>`;
                const cardsCont = div.querySelector('.cards-container');
                (boardData.data[col] || []).forEach(c => {
                    const el = document.createElement('div');
                    el.className = `card ${c.priority || 'low'}`;
                    el.innerText = c.title;
                    el.onclick = () => openModal(c.id);
                    cardsCont.appendChild(el);
                });
                const add = document.createElement('div');
                add.innerHTML = `<input type="text" style="width:100%; padding:8px; box-sizing:border-box;"><button onclick="window.addCard('${col}', this)" class="btn-primary" style="margin-top:8px;">+</button>`;
                div.appendChild(add);
                canvas.appendChild(div);
            });
        }

        async function safeSave() {
            if(!isDataReady || !currentBoardId) return;
            await updateDoc(doc(db, "boards", currentBoardId), { data: boardData.data, collaborators: boardData.collaborators });
        }

        window.addCard = (col, btn) => {
            const input = btn.previousElementSibling; if(!input.value) return;
            boardData.data[col].push({ id: 'c'+Date.now(), title: input.value, priority: 'low', checklist: [], desc: '' });
            input.value = ''; renderKanban(); safeSave();
        };

        // --- MODAL ---
        let currentEditingId = null;
        function openModal(id) {
            currentEditingId = id; const card = findCard(id);
            document.getElementById('modal-title').value = card.title;
            document.getElementById('modal-desc').value = card.desc || '';
            document.getElementById('modal-priority').value = card.priority || 'low';
            renderChecklist(card);
            document.getElementById('card-modal').style.display = 'block';
        }
        function findCard(id) { return [...boardData.data.todo, ...boardData.data['in-progress'], ...boardData.data.done].find(c => c.id === id); }
        window.closeModal = () => document.getElementById('card-modal').style.display = 'none';

        window.updatePriority = () => { findCard(currentEditingId).priority = document.getElementById('modal-priority').value; renderKanban(); safeSave(); };
        
        window.addChecklistItem = () => {
            const card = findCard(currentEditingId); card.checklist = card.checklist || [];
            card.checklist.push({ text: document.getElementById('new-check-input').value, done: false });
            document.getElementById('new-check-input').value = ''; renderChecklist(card); safeSave();
        };

        function renderChecklist(card) {
            const cont = document.getElementById('modal-checklist');
            cont.innerHTML = (card.checklist || []).map((it, i) => `<div style="padding:8px 0; border-bottom:1px solid #eee;"><input type="checkbox" ${it.done ? 'checked' : ''} onchange="window.toggleCheck(${i})"> <span style="${it.done ? 'text-decoration:line-through; opacity:0.5' : ''}">${it.text}</span></div>`).join('');
            const done = (card.checklist || []).filter(x => x.done).length;
            const pc = card.checklist?.length ? Math.round((done/card.checklist.length)*100) : 0;
            document.getElementById('progress-fill').style.width = pc+'%';
            document.getElementById('check-percent').innerText = pc+'%';
        }

        window.toggleCheck = (i) => { const card = findCard(currentEditingId); card.checklist[i].done = !card.checklist[i].done; renderChecklist(card); safeSave(); };
        window.archiveCard = () => { if(!confirm("Eliminar?")) return; ['todo','in-progress','done'].forEach(c => boardData.data[c] = boardData.data[c].filter(x => x.id !== currentEditingId)); window.closeModal(); renderKanban(); safeSave(); };
        
        document.getElementById('modal-title').onblur = e => { findCard(currentEditingId).title = e.target.value; renderKanban(); safeSave(); };
        document.getElementById('modal-desc').onblur = e => { findCard(currentEditingId).desc = e.target.value; safeSave(); };
    </script>
</body>
</html>
