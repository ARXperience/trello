<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Task Enterprise | V15 FINAL (Standard)</title>
    <style>
        /* --- ESTILOS (CSS) --- */
        :root { --primary: #0079bf; --bg: #ffffff; --sidebar: #f4f5f7; --text: #172b4d; --card: #fff; --error: #eb5a46; --success: #61bd4f; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar h3 { padding: 20px; margin: 0; font-size: 0.8rem; color: #666; border-bottom: 1px solid #ddd; text-transform: uppercase; }
        .board-list { flex: 1; overflow-y: auto; padding: 10px; }
        .board-item { padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .board-item:hover { background: #ddd; }
        .board-item.active { background: #e4f0f6; color: var(--primary); font-weight: bold; border-left: 3px solid var(--primary); }
        
        .main { flex: 1; display: flex; flex-direction: column; background: white; }
        header { background: var(--primary); padding: 0 20px; height: 50px; display: flex; align-items: center; justify-content: space-between; color: white; }
        
        /* Kanban */
        .kanban { display: flex; padding: 20px; gap: 15px; overflow-x: auto; height: 100%; align-items: flex-start; background: #fff; }
        .list { background: #ebecf0; width: 280px; min-width: 280px; border-radius: 8px; padding: 10px; max-height: 90%; display: flex; flex-direction: column; }
        .cards { flex: 1; overflow-y: auto; min-height: 20px; }
        .card { background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 2px #00000030; cursor: pointer; border-left: 4px solid #ccc; font-size: 0.9rem; position: relative; }
        .card:hover { background: #f8f8f8; }
        .card.low { border-left-color: var(--success); }
        .card.medium { border-left-color: #f2d600; }
        .card.high { border-left-color: var(--error); }
        
        /* Auth & Modal */
        .overlay { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px; width: 100%; background: var(--primary); color: white; border: none; cursor: pointer; margin-top: 10px; border-radius: 4px; font-weight: bold; }
        button.secondary { background: transparent; color: white; border: 1px solid white; }
        button.danger { background: var(--error); }
        
        /* Modal Detalle */
        #modal-overlay { background: rgba(0,0,0,0.6); display: none; position: fixed; inset: 0; z-index: 3000; justify-content: center; align-items: center;}
        .modal-box { background: #f4f5f7; width: 500px; max-height: 90vh; overflow-y: auto; text-align: left; position: relative; padding: 20px; border-radius: 8px; }
        .close-btn { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #888; }
        
        /* Utils */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .checklist-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="loading-screen" class="overlay" style="display: none; background: rgba(255,255,255,0.95); z-index: 2000;">
        <div class="box" style="box-shadow: none; background: transparent;">
            <div class="loader"></div>
            <h3 style="color:#333">Conectando a "pro-task-app"...</h3>
        </div>
    </div>

    <div id="auth-screen" class="overlay">
        <div class="box">
            <h2 style="color:var(--primary)">Pro-Task v15</h2>
            <p>Conectado a Base de Datos Nativa</p>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button onclick="login()">Iniciar Sesi√≥n</button>
            <button onclick="register()" style="background: white; color: var(--primary); border: 1px solid var(--primary);">Registrarse</button>
            <p id="auth-msg" style="color:red; font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-screen" class="app-container" style="display: none;">
        <div class="sidebar">
            <h3>MIS PROYECTOS</h3>
            <div id="board-list" class="board-list"></div>
            <div style="padding:15px"><button onclick="createBoard()">+ Nuevo Proyecto</button></div>
        </div>
        <div class="main">
            <header>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <strong id="header-title">Selecciona un proyecto</strong>
                    <span id="save-indicator" style="font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; display: none;">Guardando...</span>
                </div>
                <div>
                    <span id="user-display" style="font-size: 0.8rem; margin-right: 10px;"></span>
                    <button onclick="logout()" style="width:auto; padding:5px 15px; background:rgba(255,255,255,0.2);">Salir</button>
                </div>
            </header>
            <div id="kanban" class="kanban">
                <div style="margin: 50px auto; text-align: center; color: #888;">
                    <p>‚Üê Crea o selecciona un proyecto del men√∫.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <input type="text" id="m-title" style="font-size:1.4rem; font-weight:bold; border:none; padding-left:0; width: 100%;">
            
            <label style="font-size:0.8rem; color:#666;">Prioridad</label>
            <select id="m-priority" onchange="updateTaskMeta()">
                <option value="low">Baja (Verde)</option>
                <option value="medium">Media (Amarillo)</option>
                <option value="high">Alta (Rojo)</option>
            </select>
            
            <label style="font-size:0.8rem; color:#666;">Descripci√≥n</label>
            <textarea id="m-desc" rows="4" placeholder="Detalles..." onblur="updateTaskMeta()"></textarea>
            
            <label style="font-size:0.8rem; color:#666;">Checklist</label>
            <div id="m-checklist"></div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input id="m-new-check" placeholder="Nueva sub-tarea...">
                <button onclick="addCheck()" style="width:auto;">+</button>
            </div>
            
            <button onclick="deleteCard()" class="danger" style="margin-top: 30px;">Eliminar Tarea</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- TUS CREDENCIALES ---
        const firebaseConfig = {
            apiKey: "AIzaSyAQnrIODc_2Qv_Snow02X-Sq8_PHwMoRVk",
            authDomain: "trello-d2532.firebaseapp.com",
            projectId: "trello-d2532",
            storageBucket: "trello-d2532.firebasestorage.app",
            messagingSenderId: "630892154656",
            appId: "1:630892154656:web:1d0dfce355216a1d879145",
            measurementId: "G-4L4P7E6TZC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- üî¥ CONEXI√ìN CORRECTA A "pro-task-app" ---
        const db = getFirestore(app, "pro-task-app");
        // ---------------------------------------------

        let currentUser = null;
        let currentBoardId = null;
        let boardData = null;
        let unsubscribeBoard = null;
        let dataLoaded = false; 

        // 1. AUTH
        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        };

        window.register = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        };

        window.logout = () => { localStorage.clear(); signOut(auth); location.reload(); };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                loadBoardList(); 
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        // 2. GESTI√ìN DE TABLEROS
        function loadBoardList() {
            // Escuchar cambios en "pro-task-app"
            const q = query(collection(db, `users/${currentUser.uid}/boards`), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('board-list');
                list.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const div = document.createElement('div');
                    div.className = `board-item ${docSnap.id === currentBoardId ? 'active' : ''}`;
                    div.innerHTML = `üìÅ ${d.name}`;
                    div.onclick = () => openBoard(docSnap.id);
                    list.appendChild(div);
                });

                // Rescate de sesi√≥n
                const lastId = localStorage.getItem('lastBoardId');
                if (lastId && !currentBoardId) {
                    const exists = snapshot.docs.find(d => d.id === lastId);
                    if (exists) openBoard(lastId);
                    else localStorage.removeItem('lastBoardId');
                }
            });
        }

        window.createBoard = async () => {
            const name = prompt("Nombre del proyecto:");
            if (!name) return;
            try {
                const ref = await addDoc(collection(db, `users/${currentUser.uid}/boards`), {
                    name: name,
                    createdAt: serverTimestamp(),
                    columns: { todo: [], doing: [], done: [] }
                });
                openBoard(ref.id);
            } catch (e) {
                alert("Error al guardar. Verifica que creaste la BD en 'Standard Edition' y 'Test Mode'.");
                console.error(e);
            }
        };

        function openBoard(id) {
            if (unsubscribeBoard) unsubscribeBoard();
            dataLoaded = false; 
            currentBoardId = id;
            localStorage.setItem('lastBoardId', id);
            
            document.getElementById('loading-screen').style.display = 'flex';

            unsubscribeBoard = onSnapshot(doc(db, `users/${currentUser.uid}/boards`, id), (docSnap) => {
                document.getElementById('loading-screen').style.display = 'none';
                
                if (!docSnap.exists()) return; 
                
                boardData = docSnap.data();
                dataLoaded = true; 
                
                document.getElementById('header-title').innerText = boardData.name;
                renderKanban();
                
                document.querySelectorAll('.board-item').forEach(el => el.classList.remove('active'));
            });
        }

        // 3. RENDERIZADO
        function renderKanban() {
            const container = document.getElementById('kanban');
            container.innerHTML = '';
            
            const cols = { todo: "Pendientes", doing: "En Proceso", done: "Hecho" };
            
            for (const [key, title] of Object.entries(cols)) {
                const list = document.createElement('div');
                list.className = 'list';
                
                const addBtn = `<button onclick="window.addTask('${key}')" style="background:transparent; color:#666; border:1px dashed #ccc; margin-bottom:10px;">+ A√±adir</button>`;
                
                list.innerHTML = `<h4>${title}</h4><div class="cards" id="col-${key}"></div>${addBtn}`;
                
                const cardArea = list.querySelector('.cards');
                cardArea.ondragover = e => e.preventDefault();
                cardArea.ondrop = e => handleDrop(e, key);

                (boardData.columns[key] || []).forEach(task => {
                    const card = document.createElement('div');
                    card.className = `card ${task.priority}`;
                    card.innerText = task.title;
                    card.draggable = true;
                    card.ondragstart = e => e.dataTransfer.setData('text', JSON.stringify({ id: task.id, src: key }));
                    card.onclick = () => openModal(task, key);
                    cardArea.appendChild(card);
                });
                
                container.appendChild(list);
            }
        }

        // 4. GUARDADO
        async function saveToCloud() {
            if (!dataLoaded || !currentBoardId) return; 
            
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'block';
            indicator.innerText = "Guardando...";

            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/boards`, currentBoardId), {
                    columns: boardData.columns
                });
                indicator.innerText = "‚úÖ Guardado";
                setTimeout(() => indicator.style.display = 'none', 1500);
            } catch (e) {
                indicator.innerText = "‚ùå Error";
                console.error(e);
            }
        }

        // 5. OPERACIONES
        window.addTask = (col) => {
            const title = prompt("Tarea:");
            if (!title) return;
            if (!boardData.columns[col]) boardData.columns[col] = [];
            
            boardData.columns[col].push({ id: Date.now().toString(), title, priority: 'low', desc: '', checklist: [] });
            renderKanban();
            saveToCloud();
        };

        window.handleDrop = (e, destCol) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text'));
            if (data.src === destCol) return;

            const srcList = boardData.columns[data.src];
            const idx = srcList.findIndex(t => t.id === data.id);
            if(idx > -1) {
                const [task] = srcList.splice(idx, 1);
                if (!boardData.columns[destCol]) boardData.columns[destCol] = [];
                boardData.columns[destCol].push(task);
                renderKanban();
                saveToCloud();
            }
        };

        // 6. MODAL
        let editTask = null;
        let editCol = null;

        window.openModal = (task, col) => {
            editTask = task; editCol = col;
            document.getElementById('m-title').value = task.title;
            document.getElementById('m-priority').value = task.priority || 'low';
            document.getElementById('m-desc').value = task.desc || '';
            renderChecklist();
            document.getElementById('modal-overlay').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

        window.renderChecklist = () => {
            const div = document.getElementById('m-checklist');
            div.innerHTML = (editTask.checklist || []).map((item, i) => `
                <div class="checklist-item">
                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleCheck(${i})" style="width:auto;">
                    <span style="${item.done ? 'text-decoration:line-through; color:#aaa;' : ''}">${item.text}</span>
                    <span onclick="deleteCheck(${i})" style="margin-left:auto; color:red; cursor:pointer;">&times;</span>
                </div>
            `).join('');
        };

        window.addCheck = () => {
            const val = document.getElementById('m-new-check').value;
            if(!val) return;
            if(!editTask.checklist) editTask.checklist = [];
            editTask.checklist.push({ text: val, done: false });
            document.getElementById('m-new-check').value = '';
            renderChecklist();
            saveToCloud();
        };

        window.toggleCheck = (i) => {
            editTask.checklist[i].done = !editTask.checklist[i].done;
            renderChecklist(); 
            saveToCloud();
        };

        window.deleteCheck = (i) => {
            editTask.checklist.splice(i, 1);
            renderChecklist();
            saveToCloud();
        };

        window.updateTaskMeta = () => {
            if (!editTask) return;
            editTask.title = document.getElementById('m-title').value;
            editTask.priority = document.getElementById('m-priority').value;
            editTask.desc = document.getElementById('m-desc').value;
            renderKanban(); 
            saveToCloud();
        };

        window.deleteCard = () => {
            if(!confirm("¬øBorrar definitivamente?")) return;
            const list = boardData.columns[editCol];
            const idx = list.findIndex(t => t.id === editTask.id);
            if (idx > -1) list.splice(idx, 1);
            closeModal();
            renderKanban();
            saveToCloud();
        };

        document.getElementById('m-title').onblur = updateTaskMeta;
    </script>
</body>
</html>
