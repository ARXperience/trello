
<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro-Task v49 | Stable Mobile AI</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- ESTILOS BASE --- */
        :root {
            --primary: #0079bf; --bg: #ffffff; --sidebar: #f4f5f7; --surface: #ffffff;
            --text: #172b4d; --text-sub: #5e6c84; --border: #dfe1e6;
            --success: #61bd4f; --danger: #eb5a46; --warning: #ff9f1a; --info: #00c2e0;
            --shadow: 0 1px 3px rgba(0,0,0,0.12); --radius: 6px;
        }
        [data-theme="dark"] {
            --primary: #4a90e2; --bg: #1e1e1e; --sidebar: #252526; --surface: #2d2d30;
            --text: #e1e1e1; --text-sub: #a1a1a1; --border: #3e3e42;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); background: var(--bg); user-select: none; }
        
        /* LAYOUT */
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; width: 100%; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 20px; height: 55px; display: flex; align-items: center; justify-content: space-between; }
        
        /* MOBILE MENU */
        #mobile-menu-btn { display: none; font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--text); margin-right: 10px; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 80%; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(0); }
            #mobile-menu-btn { display: block; }
            .kanban { padding: 10px; gap: 10px; scroll-snap-type: x mandatory; }
            .list { min-width: 85vw; width: 85vw; scroll-snap-align: center; }
            .box { width: 90% !important; max-height: 85vh; }
            #webcam-container { width: 100px; height: 75px; bottom: 70px; right: 10px; }
        }

        /* KANBAN */
        .kanban { display: flex; padding: 20px; gap: 15px; overflow-x: auto; height: 100%; align-items: flex-start; }
        .list { background: var(--sidebar); width: 280px; min-width: 280px; border-radius: var(--radius); padding: 10px; max-height: 90%; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .list h4 { margin: 0 0 10px 5px; color: var(--text); font-weight: 700; display:flex; justify-content:space-between; }
        .cards { flex: 1; overflow-y: auto; min-height: 20px; padding-right: 4px; margin-bottom: 10px; }
        
        /* TARJETA */
        .card { background: var(--surface); padding: 10px; margin-bottom: 8px; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); border-left: 4px solid #ccc; position: relative; transition: transform 0.1s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .card.urgent, .card.high { border-left-color: var(--danger); }
        .card.medium { border-left-color: var(--warning); }
        .card.low { border-left-color: var(--success); }
        .card.feature { border-left-color: var(--info); }

        .card-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 5px; }
        .tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 600; }
        .tag.urgent { background: var(--danger); } 
        .tag.feature { background: var(--info); }
        .tag.bug { background: #E91E63; }

        .card-meta { display: flex; gap: 8px; margin-top: 8px; font-size: 0.75rem; color: var(--text-sub); align-items: center; flex-wrap: wrap; }
        .meta-badge { background: var(--bg); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border); }
        .meta-badge.overdue { background: #ffe3e3; color: var(--danger); border-color: var(--danger); font-weight: bold; }
        .meta-badge.today { background: #fff8e1; color: var(--warning); border-color: var(--warning); font-weight: bold; }

        .avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; border: 2px solid var(--surface); margin-left: auto; }
        .progress-bar { height: 4px; background: #eee; border-radius: 2px; margin-top: 8px; overflow: hidden; width: 100%; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

        /* UI ELEMENTS */
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); }
        .btn-add-task { width: 100%; text-align: left; background: transparent; color: var(--text-sub); border: 1px dashed var(--border); padding: 8px; cursor: pointer; margin-top:5px; }
        .btn-add-task:hover { background: rgba(0,0,0,0.05); color: var(--primary); border-color: var(--primary); }
        input, select, textarea { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }

        /* VISI√ìN IA ELEMENTS */
        #webcam-container { position: fixed; bottom: 80px; right: 20px; width: 200px; height: 150px; background: black; border-radius: 10px; overflow: hidden; border: 3px solid var(--primary); z-index: 5000; display: none; transform: scaleX(-1); }
        #webcam-feed { width: 100%; height: 100%; object-fit: cover; }
        #camera-status { position: absolute; bottom: 5px; left: 0; width: 100%; text-align: center; color: white; font-size: 0.7rem; background: rgba(0,0,0,0.5); pointer-events: none; }
        
        #virtual-cursor { position: fixed; top: 0; left: 0; width: 30px; height: 30px; background: rgba(0, 194, 224, 0.6); border: 3px solid white; border-radius: 50%; pointer-events: none; z-index: 9999; display: none; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--info); transition: width 0.1s, height 0.1s, background 0.1s; }
        #virtual-cursor.pinching { background: var(--success); width: 20px; height: 20px; border-color: lime; }

        #ai-ghost-card { position: fixed; width: 260px; padding: 15px; background: var(--surface); box-shadow: 0 20px 40px rgba(0,0,0,0.5); border-radius: 8px; border: 3px solid var(--success); z-index: 9998; pointer-events: none; opacity: 0.9; display: none; transform: rotate(5deg) scale(1.1); }

        .ai-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--text); color: var(--bg); padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 5001; display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; }

        /* MODAL Y TABS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .box { background: var(--surface); padding: 25px; border-radius: 8px; width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .modal-lg { width: 700px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .tab { padding: 10px 15px; cursor: pointer; color: var(--text-sub); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        .task-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        /* MICROFONO */
        .mic-wrapper { position: relative; display: flex; align-items: center; width: 100%; margin-bottom: 10px; }
        .mic-wrapper input, .mic-wrapper textarea { padding-right: 45px; }
        .mic-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: var(--danger); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .mic-btn:hover { transform: translateY(-50%) scale(1.1); }
        .mic-active { animation: pulse 1s infinite; background: red; }
        @keyframes pulse { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.2); } 100% { transform: translateY(-50%) scale(1); } }

        /* UTILIDADES */
        .checklist-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid #eee; }
        #toast { position: fixed; top: 70px; right: 20px; background: #172b4d; color: white; padding: 15px; border-radius: 5px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 6000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-left: 5px solid var(--success); cursor: pointer; }
        #toast.show { opacity: 1; pointer-events: auto; }
        .board-item { padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 2px; color: var(--text); display: flex; justify-content: space-between; align-items: center; }
        .board-item:hover { background: rgba(0,0,0,0.05); }
        .board-item.active { background: #e4f0f6; color: var(--primary); font-weight: bold; }
        .badge-new { background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; }
        .bell-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 10px; display: none; }
        
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 900; }
    </style>
</head>
<body>

    <div id="virtual-cursor"></div>
    <div id="ai-ghost-card">
        <strong id="ghost-title">Tarea</strong>
        <div style="font-size:0.8rem; margin-top:5px; color:var(--text-sub);">Suelta los dedos para dejar caer</div>
    </div>
    <div id="webcam-container">
        <video id="webcam-feed" autoplay playsinline></video>
        <div id="camera-status">Iniciando...</div>
    </div>
    <div id="toast" onclick="openToastBoard()">
        <strong id="toast-title">Notificaci√≥n</strong>
        <div id="toast-msg"></div>
    </div>

    <button class="ai-toggle" onclick="window.toggleAI()">üëÅÔ∏è Activar C√°mara</button>

    <div id="auth-screen" class="overlay" style="background: var(--primary);">
        <div class="box">
            <h2 style="text-align:center; color:white;">Pro-Task v49</h2>
            <p style="text-align:center; color:white; opacity:0.8;">Mobile & Stable</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" style="width:100%; margin-top:10px; background:white; color:var(--primary);" onclick="window.login()">Entrar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px; color:white; border-color:white;" onclick="window.register()">Crear Cuenta</button>
            <p id="auth-msg" style="color:white; text-align:center; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div id="app-screen" class="app-container" style="display: none;">
        <div id="sidebar-overlay" onclick="window.toggleSidebar()"></div>
        
        <div class="sidebar" id="sidebar">
            <div style="padding:15px; font-weight:bold; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                <span>‚ö° PRO-TASK</span>
                <span onclick="window.toggleSidebar()" style="cursor:pointer; font-size:1.2rem; display:none;" id="close-sidebar-btn">&times;</span>
            </div>
            <div style="padding:0 10px; font-size:0.7rem; color:var(--text-sub); font-weight:bold;">MIS PROYECTOS</div>
            <div id="my-boards" style="flex:1; overflow-y:auto; padding:10px;"></div>
            <div style="padding:0 10px; font-size:0.7rem; color:var(--text-sub); font-weight:bold;">COMPARTIDOS</div>
            <div id="shared-boards" style="max-height:150px; overflow-y:auto; padding:10px;"></div>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn-primary" style="width:100%;" onclick="window.createBoard()">+ Nuevo Tablero</button>
                <div onclick="window.openTrash()" style="margin-top:10px; cursor:pointer; text-align:center; font-size:0.9rem; color:var(--text-sub);">üóëÔ∏è Papelera</div>
            </div>
        </div>

        <div class="main">
            <header>
                <div style="display:flex; align-items:center;">
                    <button id="mobile-menu-btn" onclick="window.toggleSidebar()">‚ò∞</button>
                    <div class="search-box"><span>üîç</span><input type="text" placeholder="Buscar..." onkeyup="window.filterCards(this.value)"></div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-ghost" onclick="window.exportCSV()">üìä</button>
                    <button class="btn-ghost" onclick="window.openStats()">üìà</button>
                    <div style="position:relative; cursor:pointer;" onclick="window.openUnread()">
                        üîî <span id="bell-count" class="bell-count">0</span>
                    </div>
                    <button class="btn-ghost" onclick="window.toggleTheme()">üåì</button>
                    <span id="user-display" style="font-size:0.8rem; display:none;"></span>
                    <button class="btn-ghost" onclick="window.logout()">üö™</button>
                </div>
            </header>
            
            <div style="padding:10px 20px; display:flex; justify-content:space-between; align-items:center;">
                <h2 id="header-title" style="margin:0;">Tablero</h2>
                <div id="board-actions" style="display:none;">
                    <button class="btn-ghost" onclick="window.openShare()">üë§ Invitar</button>
                    <button class="btn-ghost" style="color:var(--danger);" onclick="window.softDeleteBoard()">üóëÔ∏è</button>
                </div>
            </div>

            <div id="kanban" class="kanban"></div>
        </div>
    </div>

    <div id="task-modal" class="overlay" style="display: none;">
        <div class="box modal-lg">
            <span onclick="window.closeModals()" style="align-self:flex-end; cursor:pointer; font-size:1.5rem;">&times;</span>
            <div id="m-cover-preview" style="height:100px; background:#eee; border-radius:4px; margin-bottom:10px; background-size:cover; background-position:center; display:none;"></div>
            <div class="mic-wrapper">
                <input type="text" id="m-title" style="font-size:1.5rem; font-weight:bold; border:none; background:transparent;" onblur="window.updateTask()" placeholder="T√≠tulo">
                <div class="mic-btn" onclick="window.startDictation('m-title')">üé§</div>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('details', this)">Detalles</div>
                <div class="tab" onclick="window.switchTab('comments', this)">Comentarios</div>
                <div class="tab" onclick="window.switchTab('files', this)">Adjuntos</div>
            </div>
            <div id="tab-details">
                <div class="task-grid">
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Prioridad/Etiqueta</label>
                        <select id="m-tag" onchange="window.updateTask()">
                            <option value="low">üü¢ Baja</option>
                            <option value="medium">üü° Media</option>
                            <option value="high">üî¥ Alta</option>
                            <option value="urgent">üî• URGENTE</option>
                            <option value="bug">üêõ Bug</option>
                            <option value="feature">‚ú® Feature</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Vencimiento</label>
                        <input type="date" id="m-due" onchange="window.updateTask()">
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Asignar a</label>
                        <select id="m-assignee" onchange="window.updateTask()"></select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem; color:var(--text-sub);">Cron√≥metro</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <button id="btn-timer" class="btn-ghost" onclick="window.toggleTimer()">‚ñ∂Ô∏è Play</button>
                            <span id="m-timer-display" style="font-weight:bold; font-family:monospace; font-size:1.1rem;">00:00:00</span>
                        </div>
                    </div>
                </div>
                <label style="font-size:0.8rem; color:var(--text-sub);">Descripci√≥n</label>
                <div class="mic-wrapper" style="align-items:flex-start">
                    <textarea id="m-desc" rows="3" onblur="window.updateTask()"></textarea>
                    <div class="mic-btn" style="top:10px; transform:none;" onclick="window.startDictation('m-desc')">üé§</div>
                </div>
                <div style="margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>Checklist</strong>
                        <span id="m-progress-text" style="font-size:0.8rem;">0%</span>
                    </div>
                    <div class="progress-bar"><div id="m-progress-bar" class="progress-fill"></div></div>
                    <div id="m-checklist" style="margin-top:10px;"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <div class="mic-wrapper" style="width:100%; margin:0;">
                            <input id="m-new-check" placeholder="Nueva subtarea..." onkeypress="if(event.key==='Enter') window.addCheck()">
                            <div class="mic-btn" onclick="window.startDictation('m-new-check')">üé§</div>
                        </div>
                        <button class="btn-ghost" onclick="window.addCheck()">+</button>
                    </div>
                </div>
            </div>
            <div id="tab-comments" style="display:none;">
                <div id="comment-list" style="margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
                <div style="display:flex; gap:5px;">
                    <div class="mic-wrapper" style="width:100%; margin:0;">
                        <input id="m-new-comment" placeholder="Comentar...">
                        <div class="mic-btn" onclick="window.startDictation('m-new-comment')">üé§</div>
                    </div>
                    <button class="btn-primary" onclick="window.addComment()">Enviar</button>
                </div>
            </div>
            <div id="tab-files" style="display:none;">
                <label>Portada (URL)</label>
                <input id="m-cover-url" placeholder="https://..." onblur="window.updateTask()" style="margin-bottom:10px;">
                <div id="file-list" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:5px;">
                    <div class="mic-wrapper" style="width:100%; margin:0;">
                        <input id="m-file-name" placeholder="Nombre">
                        <div class="mic-btn" onclick="window.startDictation('m-file-name')">üé§</div>
                    </div>
                    <input id="m-file-url" placeholder="URL">
                    <button class="btn-ghost" onclick="window.addFile()">+</button>
                </div>
            </div>
            <div style="margin-top:20px; text-align:right; border-top:1px solid var(--border); padding-top:10px;">
                <button class="btn-danger" style="background:var(--danger); color:white;" onclick="window.deleteTask()">Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="overlay" style="display:none;">
        <div class="box">
            <h3>Invitar</h3>
            <input id="share-email" placeholder="Email">
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="window.shareBoard()">Enviar</button>
            <button class="btn-ghost" style="width:100%; margin-top:5px;" onclick="window.closeModals()">Cancelar</button>
        </div>
    </div>

    <div id="stats-modal" class="overlay" style="display:none;">
        <div class="box">
            <h3>Estad√≠sticas</h3>
            <div id="stats-content"></div>
            <button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="window.closeModals()">Cerrar</button>
        </div>
    </div>

    <div id="trash-modal" class="overlay" style="display:none;">
        <div class="box modal-lg">
            <h3>Papelera</h3>
            <div id="trash-list" style="margin-top:10px;"></div>
            <button class="btn-ghost" style="margin-top:10px;" onclick="window.closeModals()">Cerrar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- HELPERS GLOBALES (AL INICIO) ---
        window._id = (id) => document.getElementById(id);
        window._val = (id) => document.getElementById(id).value;
        window.closeModals = () => document.querySelectorAll('.overlay').forEach(e => { if(e.id!=='auth-screen') e.style.display='none'; });
        window.toggleTheme = () => { const h=document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark'); };
        window.filterCards = (q) => document.querySelectorAll('.card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q.toLowerCase()) ? 'block' : 'none');
        window.openUnread = () => { const u = document.querySelector('.board-item.unread'); if(u) u.click(); else alert("No hay novedades"); };

        const firebaseConfig = {
            apiKey: "AIzaSyAQnrIODc_2Qv_Snow02X-Sq8_PHwMoRVk",
            authDomain: "trello-d2532.firebaseapp.com",
            projectId: "trello-d2532",
            storageBucket: "trello-d2532.firebasestorage.app",
            messagingSenderId: "630892154656",
            appId: "1:630892154656:web:1d0dfce355216a1d879145"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app, "pro-task-app");

        let currentUser = null;
        let currentBoardId = null;
        let boardData = null;
        let editTask = null; let editCol = null;
        let pendingToastBoardId = null;
        let seenBoards = JSON.parse(localStorage.getItem('seenBoards') || '[]');
        window.activeTimers = {};

        // --- MOBILE MENU LOGIC ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        };

        // --- AUTH ---
        window.login = () => signInWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => { _id('auth-msg').innerText = e.message; _id('auth-msg').style.display = 'block'; });
        window.register = () => createUserWithEmailAndPassword(auth, _val('email'), _val('password')).catch(e => { _id('auth-msg').innerText = e.message; _id('auth-msg').style.display = 'block'; });
        window.logout = () => { signOut(auth); location.reload(); };

        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                initDashboard();
            }
        });

        // --- CORE & NOTIFICATIONS ---
        function initDashboard() {
            onSnapshot(query(collection(db, 'boards'), where('ownerId', '==', currentUser.uid)), snap => {
                _id('my-boards').innerHTML = '';
                if(snap.empty) _id('my-boards').innerHTML = '<div style="padding:10px; color:#999; font-size:0.8rem;">(Vac√≠o)</div>';
                snap.forEach(d => { if(!d.data().deleted) _id('my-boards').innerHTML += renderBoardItem(d.id, d.data()); });
            });

            const qShared = query(collection(db, 'boards'), where('members', 'array-contains', currentUser.email));
            let isFirstLoad = true;

            onSnapshot(qShared, snap => {
                const container = _id('shared-boards'); 
                container.innerHTML = '';
                if(snap.empty) container.innerHTML = '<div style="padding:10px; color:#999; font-size:0.8rem;">(Vac√≠o)</div>';
                let unreadCount = 0;

                snap.docChanges().forEach(change => {
                    if (change.type === "added" && !isFirstLoad) {
                        const bData = change.doc.data();
                        if(bData.ownerId !== currentUser.uid && !bData.deleted) {
                             showToast("üîî Nueva Invitaci√≥n", `Te han invitado a: ${bData.name}`, change.doc.id);
                        }
                    }
                });

                snap.forEach(d => {
                    const data = d.data();
                    if (!data.deleted && data.ownerId !== currentUser.uid) {
                        const isUnread = !seenBoards.includes(d.id);
                        if (isUnread) unreadCount++;
                        container.innerHTML += renderBoardItem(d.id, data, true, isUnread);
                    }
                });

                const bell = _id('bell-count');
                if (unreadCount > 0) { bell.style.display = 'block'; bell.innerText = unreadCount; } else { bell.style.display = 'none'; }
                isFirstLoad = false;
            });
        }

        const renderBoardItem = (id, data, shared, unread) => {
            return `<div class="board-item ${unread?'unread':''}" onclick="window.openBoard('${id}', ${shared})">
                <span>${shared?'üë•':'üìÅ'} ${data.name}</span>
                ${unread ? '<span class="badge-new">NUEVO</span>' : ''}
            </div>`;
        };

        window.createBoard = async () => {
            const name = prompt("Nombre:"); if(!name) return;
            const res = await addDoc(collection(db, 'boards'), {
                name, ownerId: currentUser.uid, members: [currentUser.email],
                deleted: false, createdAt: serverTimestamp(), columns: { todo: [], doing: [], done: [] }
            });
            window.openBoard(res.id);
        };

        window.openBoard = (id, isShared = false) => {
            currentBoardId = id;
            if (isShared && !seenBoards.includes(id)) {
                seenBoards.push(id);
                localStorage.setItem('seenBoards', JSON.stringify(seenBoards));
                _id('bell-count').style.display = 'none'; 
            }
            onSnapshot(doc(db, 'boards', id), snap => {
                if(!snap.exists() || snap.data().deleted) return _id('kanban').innerHTML = '<p style="padding:20px;">No disponible</p>';
                boardData = snap.data();
                _id('header-title').innerText = boardData.name;
                _id('board-actions').style.display = (boardData.ownerId === currentUser.uid) ? 'block' : 'none';
                
                if(window.innerWidth <= 768 && _id('sidebar').classList.contains('open')) window.toggleSidebar();
                
                renderKanban();
            });
        };

        // --- KANBAN ---
        function renderKanban() {
            const container = _id('kanban'); container.innerHTML = '';
            const cols = { todo: "Por Hacer", doing: "En Progreso", done: "Hecho" };
            
            for (let k in cols) {
                const list = document.createElement('div'); list.className = 'list';
                list.id = `col-${k}`; list.setAttribute('data-col', k);
                list.innerHTML = `<h4>${cols[k]} <span>${(boardData.columns[k]||[]).length}</span></h4>`;
                
                const cardCont = document.createElement('div'); cardCont.className = 'cards';
                cardCont.ondragover = e => e.preventDefault();
                cardCont.ondrop = e => handleDrop(e, k);
                (boardData.columns[k] || []).forEach(task => cardCont.appendChild(createCard(task, k)));
                list.appendChild(cardCont);

                const btn = document.createElement('button');
                btn.className = 'btn-add-task'; btn.innerText = '+ A√±adir Tarea';
                btn.onclick = () => window.addTask(k);
                list.appendChild(btn);
                container.appendChild(list);
            }
        }

        const createCard = (task, col) => {
            const el = document.createElement('div'); el.className = `card ${task.tag || 'low'}`; el.draggable = true;
            el.setAttribute('data-task-id', task.id); el.setAttribute('data-col', col);
            el.ondragstart = e => e.dataTransfer.setData('text', JSON.stringify({id: task.id, src: col}));
            el.onclick = () => window.openTaskModal(task, col);
            
            let html = `<strong>${task.title}</strong>`;
            if(task.tag === 'urgent') html += ` <span class="tag urgent">üî•</span>`;
            
            html += `<div class="card-meta">`;
            if(task.due) {
                const today = new Date().toISOString().split('T')[0];
                let cls = '';
                if (task.due < today && col !== 'done') cls = 'overdue';
                else if (task.due === today && col !== 'done') cls = 'today';
                html += `<span class="meta-badge ${cls}">üìÖ ${task.due.slice(5)}</span>`;
            }
            if(task.checklist && task.checklist.length > 0) {
                const done = task.checklist.filter(c => c.done).length;
                html += `<span class="meta-badge">‚òë ${done}/${task.checklist.length}</span>`;
            }
            html += `</div>`;
            
            if(task.checklist && task.checklist.length > 0) {
                const pct = Math.round((task.checklist.filter(c => c.done).length / task.checklist.length) * 100);
                html += `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
            }

            el.innerHTML = html;
            return el;
        };

        // --- TASK LOGIC (NO PROMPT) ---
        window.addTask = (col) => {
            const newTask = { id: Date.now().toString(), title: "Nueva Tarea", desc: '', tag: 'low', due: '', checklist: [], comments: [], files: [], timeLog: 0 };
            boardData.columns[col].push(newTask); 
            save();
            setTimeout(() => window.openTaskModal(newTask, col), 100);
        };

        const handleDrop = (e, dest) => {
            e.preventDefault(); const data = e.dataTransfer.getData('text'); if(!data) return;
            const {id, src} = JSON.parse(data); if(src === dest) return;
            const idx = boardData.columns[src].findIndex(t => t.id === id);
            const [task] = boardData.columns[src].splice(idx, 1);
            boardData.columns[dest].push(task); save();
        };

        async function save() { await updateDoc(doc(db, 'boards', currentBoardId), { columns: boardData.columns }); }

        // --- MODAL ---
        window.openTaskModal = (task, col) => {
            editTask = task; editCol = col;
            _id('task-modal').style.display = 'flex';
            _id('m-title').value = task.title;
            _id('m-desc').value = task.desc || '';
            _id('m-due').value = task.due || '';
            _id('m-tag').value = task.tag || 'low';
            _id('m-cover-url').value = task.cover || '';
            
            const sel = _id('m-assignee'); sel.innerHTML = '<option value="">Sin Asignar</option>';
            (boardData.members || [currentUser.email]).forEach(m => {
                sel.innerHTML += `<option value="${m}" ${task.assignedTo===m?'selected':''}>${m}</option>`;
            });

            if(task.cover) { _id('m-cover-preview').style.display='block'; _id('m-cover-preview').style.backgroundImage=`url('${task.cover}')`; }
            else _id('m-cover-preview').style.display='none';
            updateTimerDisplay(); renderChecklist(); renderComments(); renderFiles();
            window.switchTab('details');
        };

        window.updateTask = () => {
            if(!editTask) return;
            editTask.title = _id('m-title').value;
            editTask.desc = _id('m-desc').value;
            editTask.due = _id('m-due').value;
            editTask.tag = _id('m-tag').value;
            editTask.assignedTo = _id('m-assignee').value;
            editTask.cover = _id('m-cover-url').value; save();
        };

        window.switchTab = (tab, btn) => {
            if(btn) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
            ['details','comments','files'].forEach(t => _id('tab-'+t).style.display = (t===tab?'block':'none'));
        };

        // SUB-FEATURES
        window.addCheck = () => {
            const val = _id('m-new-check').value; if(!val) return;
            if(!editTask.checklist) editTask.checklist = [];
            editTask.checklist.push({text: val, done: false}); _id('m-new-check').value=''; renderChecklist(); save();
        };
        const renderChecklist = () => {
            _id('m-checklist').innerHTML = (editTask.checklist||[]).map((c, i) => `<div class="checklist-item"><input type="checkbox" ${c.done?'checked':''} onchange="window.toggleCheck(${i})"> <span>${c.text}</span></div>`).join('');
            const done = editTask.checklist ? editTask.checklist.filter(c=>c.done).length : 0;
            const total = editTask.checklist ? editTask.checklist.length : 0;
            const pct = total ? Math.round((done/total)*100) : 0;
            _id('m-progress-bar').style.width = pct+'%'; _id('m-progress-text').innerText = pct+'%';
        };
        window.toggleCheck = (i) => { editTask.checklist[i].done = !editTask.checklist[i].done; renderChecklist(); save(); };

        window.addComment = () => {
            const val = _id('m-new-comment').value; if(!val) return;
            if(!editTask.comments) editTask.comments = [];
            editTask.comments.push({user: currentUser.email, text: val}); _id('m-new-comment').value=''; renderComments(); save();
        };
        const renderComments = () => {
            _id('comment-list').innerHTML = (editTask.comments||[]).map(c => `<div class="comment-item"><strong>${c.user}</strong>: ${c.text}</div>`).join('');
        };

        window.addFile = () => {
            const name = _id('m-file-name').value; const url = _id('m-file-url').value; if(!url) return;
            if(!editTask.files) editTask.files = [];
            editTask.files.push({name: name||'Link', url}); renderFiles(); save();
        };
        const renderFiles = () => {
            _id('file-list').innerHTML = (editTask.files||[]).map(f => `<a href="${f.url}" target="_blank" style="display:block; padding:5px; background:#eee; margin:5px 0;">üìé ${f.name}</a>`).join('');
        };

        window.toggleTimer = () => {
            if(window.activeTimers[editTask.id]) {
                clearInterval(window.activeTimers[editTask.id]); delete window.activeTimers[editTask.id]; _id('btn-timer').innerText = "‚ñ∂Ô∏è Play";
            } else {
                window.activeTimers[editTask.id] = setInterval(() => { editTask.timeLog = (editTask.timeLog || 0) + 1; updateTimerDisplay(); }, 1000); _id('btn-timer').innerText = "‚è∏Ô∏è Pause";
            }
        };
        function updateTimerDisplay() {
            const sec = editTask.timeLog || 0;
            const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60); const s = sec % 60;
            _id('m-timer-display').innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }

        window.deleteTask = () => {
            if(!confirm("¬øEliminar?")) return;
            boardData.columns[editCol] = boardData.columns[editCol].filter(t => t.id !== editTask.id);
            window.closeModals(); renderKanban(); save();
        };

        // --- EXPORT & STATS ---
        window.exportCSV = () => {
            let csv = "ID,Titulo,Columna,Asignado\n";
            for(let col in boardData.columns) { boardData.columns[col].forEach(t => csv += `${t.id},"${t.title}",${col},${t.assignedTo}\n`); }
            const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob); a.download = 'board.csv'; a.click();
        };
        window.openStats = () => {
            let total = 0, done = 0;
            for(let c in boardData.columns) total += boardData.columns[c].length;
            done = boardData.columns['done'].length;
            _id('stats-content').innerHTML = `<p>Total: <b>${total}</b></p><p>Finalizado: <b>${done}</b></p><div class="progress-bar" style="height:20px;"><div class="progress-fill" style="width:${total?(done/total)*100:0}%"></div></div>`;
            _id('stats-modal').style.display = 'flex';
        };

        window.openShare = () => _id('share-modal').style.display='flex';
        window.shareBoard = async () => { await updateDoc(doc(db,'boards',currentBoardId), {members: arrayUnion(_val('share-email'))}); window.closeModals(); };
        window.softDeleteBoard = async () => { if(confirm("¬øBorrar?")) await updateDoc(doc(db,'boards',currentBoardId), {deleted:true}); };
        
        function showToast(title, msg, boardId) {
            const t = _id('toast');
            _id('toast-title').innerText = title; _id('toast-msg').innerText = msg;
            pendingToastBoardId = boardId;
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 6000);
        }
        window.openToastBoard = () => { if(pendingToastBoardId) { window.openBoard(pendingToastBoardId, true); _id('toast').classList.remove('show'); } };

        window.openTrash = () => {
             onSnapshot(query(collection(db,'boards'), where('ownerId','==',currentUser.uid)), snap => {
                 let h = '';
                 snap.forEach(d => { if(d.data().deleted) h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${d.data().name}</span><button class="btn-primary" onclick="window.restore('${d.id}')">‚ôªÔ∏è</button></div>`; });
                 _id('trash-list').innerHTML = h || 'Vac√≠a';
                 _id('trash-modal').style.display='flex';
             });
        };
        window.restore = async(id) => updateDoc(doc(db,'boards',id), {deleted:false});

        // --- üé§ DICTADO ---
        window.startDictation = (inputId) => {
            if (!('webkitSpeechRecognition' in window)) return alert("Usa Chrome.");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = "es-ES";
            const btn = document.getElementById(inputId).parentNode.querySelector('.mic-btn');
            btn.classList.add('mic-active');
            recognition.onresult = (e) => { _id(inputId).value = e.results[0][0].transcript; window.updateTask(); btn.classList.remove('mic-active'); };
            recognition.onerror = () => btn.classList.remove('mic-active');
            recognition.start();
        };

        // --- üëÅÔ∏è VISI√ìN IA MANUAL (FIXED ENGINE) ---
        let videoElement = null; let canvasElement = null; let canvasCtx = null; let hands = null; let camera = null; let isAiActive = false;

        window.toggleAI = () => {
            const container = _id('webcam-container');
            const cursor = _id('virtual-cursor');
            if (isAiActive) {
                if (videoElement && videoElement.srcObject) { videoElement.srcObject.getTracks().forEach(track => track.stop()); }
                container.style.display = 'none'; cursor.style.display = 'none'; isAiActive = false; return;
            }
            container.style.display = 'block'; cursor.style.display = 'block'; isAiActive = true;
            _id('camera-status').innerText = "Cargando modelo...";
            startVision();
        };

        async function startVision() {
            videoElement = _id('webcam-feed');
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
            hands.onResults(onResults);
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => { _id('camera-status').innerText = "C√°mara lista"; requestAnimationFrame(predictWebcam); };
            } catch (err) { alert("Error c√°mara: " + err); isAiActive = false; }
        }

        async function predictWebcam() {
            if (!isAiActive) return;
            if (videoElement.readyState === 4) { await hands.send({image: videoElement}); }
            requestAnimationFrame(predictWebcam);
        }

        let isPinching = false; let dragId = null; let dragSrc = null;
        let pinchStartTime = 0; let pinchStartX = 0; let pinchStartY = 0; let isDragging = false; 

        function onResults(results) {
            const cursor = _id('virtual-cursor');
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                _id('camera-status').innerText = "Esperando mano..."; cursor.style.display = 'none'; return;
            }
            _id('camera-status').innerText = "Mano detectada"; cursor.style.display = 'block';

            const lm = results.multiHandLandmarks[0];
            const idx = lm[8]; const thb = lm[4];
            const x = (1 - idx.x) * window.innerWidth; const y = idx.y * window.innerHeight;

            cursor.style.left = x + 'px'; cursor.style.top = y + 'px';
            const dist = Math.hypot(idx.x - thb.x, idx.y - thb.y);
            const PINCH_START = 0.05; const PINCH_RELEASE = 0.08;

            // 1. PINZA START
            if (!isPinching && dist < PINCH_START) {
                isPinching = true; cursor.classList.add('pinching');
                pinchStartTime = Date.now(); pinchStartX = x; pinchStartY = y; isDragging = false;
                const elements = document.elementsFromPoint(x, y);
                const card = elements.find(el => el.classList.contains('card'));
                if (card) {
                    dragId = card.getAttribute('data-task-id'); dragSrc = card.getAttribute('data-col');
                    const ghost = _id('ai-ghost-card');
                    ghost.querySelector('strong').innerText = card.querySelector('strong').innerText;
                }
            }

            // 2. HOLDING / SCROLL / DRAG
            if (isPinching) {
                const moveDist = Math.hypot(x - pinchStartX, y - pinchStartY);
                if (moveDist > 20) {
                    if (dragId) {
                        isDragging = true; _id('ai-ghost-card').style.display = 'block';
                        const ghost = _id('ai-ghost-card');
                        ghost.style.left = (x + 20) + 'px'; ghost.style.top = (y + 20) + 'px';
                    } else if (!isDragging) {
                        // SCROLL LOGIC
                        const el = document.elementFromPoint(x, y);
                        const scrollable = el ? el.closest('.cards, .modal-lg, .list, .board-list') : null;
                        if(scrollable) {
                            scrollable.scrollTop += (pinchStartY - y) * 0.1; 
                        }
                    }
                }
            }

            // 3. RELEASE
            if (isPinching && dist > PINCH_RELEASE) {
                isPinching = false; cursor.classList.remove('pinching');
                if (isDragging && dragId) {
                    // DROP CARD
                    const elements = document.elementsFromPoint(x, y);
                    const list = elements.find(el => el.classList.contains('list'));
                    if (list) {
                        const target = list.id.replace('col-', '');
                        if (target && target !== dragSrc) {
                            const idx = boardData.columns[dragSrc].findIndex(t => t.id === dragId);
                            if (idx > -1) {
                                const [t] = boardData.columns[dragSrc].splice(idx, 1);
                                boardData.columns[target].push(t);
                                save();
                            }
                        }
                    }
                } else {
                    // CLICK (TAP)
                    const el = document.elementFromPoint(x, y);
                    if (el) {
                        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(el.tagName)) el.focus();
                        el.click();
                        // Force Open Select
                        if(el.tagName === 'SELECT') {
                            const event = new MouseEvent('mousedown', {bubbles: true, cancelable: true, view: window});
                            el.dispatchEvent(event);
                        }
                    }
                }
                _id('ai-ghost-card').style.display = 'none'; dragId = null; dragSrc = null; isDragging = false;
            }
        }
    </script>
</body>
</html>